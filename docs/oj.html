<!DOCTYPE html><html lang="en"><head><title>oj</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="oj"><meta name="groc-project-path" content="src/oj.coffee"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/oj.coffee</div></div><div id="document"><div class="segment"></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="oj">oj</h1>

<p>A unified templating framework for the people. Thirsty people.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="oj-function">oj function</h2>

<p>Convert ojml to dom</p></div></div><div class="code"><div class="wrapper"><span class="nv">oj = module.exports = </span><span class="nf">(ojml) -&gt;</span>
  <span class="nx">oj</span><span class="p">.</span><span class="nx">toDOM</span> <span class="nx">ojml</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Keep a reference to ourselves for templates to see</p></div></div><div class="code"><div class="wrapper"><span class="nv">oj.oj = </span><span class="nx">oj</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="ojbegin">oj.begin</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="nv">oj.begin = </span><span class="nf">(page) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Defer dom manipulation until the page has loaded</p></div></div><div class="code"><div class="wrapper">  <span class="nx">_readyOrLoad</span> <span class="o">-&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Compile only the body and below</p></div></div><div class="code"><div class="wrapper">    <span class="nv">bodyOnly = </span><span class="nx">html</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">doctype</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">head</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">link</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">script</span><span class="o">:</span><span class="mi">1</span>
    <span class="p">{</span><span class="nx">dom</span><span class="p">}</span> <span class="o">=</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">dom</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">html</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span> <span class="nx">css</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span> <span class="nx">ignore</span><span class="o">:</span><span class="nx">bodyOnly</span><span class="p">,</span> <span class="p">(</span><span class="nx">require</span> <span class="nx">page</span><span class="p">)</span>

    <span class="k">if</span> <span class="o">not</span> <span class="nx">dom</span><span class="o">?</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span> <span class="s">&#39;oj: dom failed to compile&#39;</span>
      <span class="k">return</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Find body</p></div></div><div class="code"><div class="wrapper">    <span class="nv">body = </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s">&#39;body&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">body</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span> <span class="s">&#39;oj: &lt;body&gt; was not found&#39;</span>
      <span class="k">return</span>
    <span class="nv">body = </span><span class="nx">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Clear body and insert dom elements</p></div></div><div class="code"><div class="wrapper">    <span class="nv">body.innerHTML = </span><span class="s">&#39;&#39;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">dom</span>
      <span class="nv">dom = </span><span class="p">[</span><span class="nx">dom</span><span class="p">]</span>
    <span class="k">for</span> <span class="nx">d</span> <span class="k">in</span> <span class="nx">dom</span>
      <span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span> <span class="nx">d</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Trigger events bound through oj.ready</p></div></div><div class="code"><div class="wrapper">    <span class="nx">oj</span><span class="p">.</span><span class="nx">ready</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="helpers">Helpers</h2>

<p>Loading with either ready or onload (whichever exists)
Loads immediately if it is already loaded</p></div></div><div class="code"><div class="wrapper"><span class="nv">_readyOrLoad = </span><span class="nf">(fn) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Use jquery ready if it exists</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="nx">$</span><span class="o">?</span>
    <span class="nx">$</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Otherwise fall back to onload</p></div></div><div class="code"><div class="wrapper">  <span class="k">else</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add onload if it hasn't happened yet</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nb">document</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">!=</span> <span class="s">&quot;complete&quot;</span>
      <span class="nv">prevOnLoad = </span><span class="nb">window</span><span class="p">.</span><span class="nx">onload</span>
      <span class="nb">window</span><span class="p">.</span><span class="nv">onload = </span><span class="o">-&gt;</span>
        <span class="nx">prevOnLoad</span><span class="o">?</span><span class="p">()</span>
        <span class="nx">fn</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Otherwise call the function</p></div></div><div class="code"><div class="wrapper">    <span class="k">else</span>
      <span class="nx">fn</span><span class="p">()</span>
  <span class="k">return</span>

<span class="nv">oj.error = </span><span class="nf">(message) -&gt;</span>
  <span class="nv">red = </span><span class="nx">oj</span><span class="p">.</span><span class="nx">codes</span><span class="o">?</span><span class="p">.</span><span class="nx">red</span> <span class="o">?</span> <span class="s">&#39;&#39;</span>
  <span class="nv">reset = </span><span class="nx">oj</span><span class="p">.</span><span class="nx">codes</span><span class="o">?</span><span class="p">.</span><span class="nx">red</span> <span class="o">?</span> <span class="s">&#39;&#39;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">error</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">red</span><span class="si">}#{</span><span class="nx">message</span><span class="si">}#{</span><span class="nx">reset</span><span class="si">}</span><span class="s">&quot;</span>
  <span class="k">return</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="ojready">oj.ready</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="nv">_readyQueue = </span><span class="nx">queue</span><span class="o">:</span><span class="p">[],</span> <span class="nx">loaded</span><span class="o">:</span><span class="kc">false</span>
<span class="nv">oj.ready = </span><span class="nf">(fn) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Call everything if no arguments</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isUndefined</span> <span class="nx">fn</span>
    <span class="nv">_readyQueue.loaded = </span><span class="kc">true</span>
    <span class="k">while</span> <span class="p">(</span><span class="nv">f = </span><span class="nx">_readyQueue</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">shift</span><span class="p">())</span>
      <span class="nx">f</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Call load if already loaded</p></div></div><div class="code"><div class="wrapper">  <span class="k">else</span> <span class="k">if</span> <span class="nx">_readyQueue</span><span class="p">.</span><span class="nx">loaded</span>
    <span class="nx">f</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Queue function for later</p></div></div><div class="code"><div class="wrapper">  <span class="k">else</span>
    <span class="nx">_readyQueue</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">push</span> <span class="nx">fn</span>
  <span class="k">return</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="ojid">oj.id</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="nv">oj.id = </span><span class="nf">(len, chars) -&gt;</span>
  <span class="s">&#39;oj&#39;</span> <span class="o">+</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">guid</span> <span class="nx">len</span><span class="p">,</span> <span class="nx">chars</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="ojguid">oj.guid</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="nv">_randomInteger = </span><span class="nf">(min, max) -&gt;</span>
  <span class="k">return</span> <span class="kc">null</span> <span class="k">if</span> <span class="nx">min</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">or</span> <span class="nx">max</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">or</span> <span class="nx">min</span> <span class="o">&gt;</span> <span class="nx">max</span>
  <span class="nv">diff = </span><span class="nx">max</span> <span class="o">-</span> <span class="nx">min</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>random int from zero to number minus one</p></div></div><div class="code"><div class="wrapper">  <span class="nv">rnd = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="nx">diff</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
  <span class="nx">rnd</span> <span class="o">+</span> <span class="nx">min</span>

<span class="nv">_chars = </span><span class="s">&quot;0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz&quot;</span><span class="p">.</span><span class="nx">split</span> <span class="s">&#39;&#39;</span>
<span class="nv">oj.guid = </span><span class="nf">(len = 8, chars = _chars) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Default arguments</p></div></div><div class="code"><div class="wrapper">  <span class="nv">base = </span><span class="nx">chars</span><span class="p">.</span><span class="nx">length</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Calculate how many chars can be determined by each random call</p></div></div><div class="code"><div class="wrapper">  <span class="nv">charsPerRand = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">31</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">base</span><span class="p">)</span>
  <span class="nv">randMin = </span><span class="mi">0</span>
  <span class="nv">randMax = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="nx">base</span><span class="p">,</span> <span class="nx">charsPerRand</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Calculate random chars by calling random the minimum number of times</p></div></div><div class="code"><div class="wrapper">  <span class="nv">output = </span><span class="s">&quot;&quot;</span>
  <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">len</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Generate random number</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">i</span> <span class="o">%</span> <span class="nx">charsPerRand</span> <span class="o">==</span> <span class="mi">0</span>
      <span class="nv">rand = </span><span class="nx">_randomInteger</span> <span class="nx">randMin</span><span class="p">,</span> <span class="nx">randMax</span>
    <span class="nv">charNext = </span><span class="nx">chars</span><span class="p">[</span><span class="nx">rand</span> <span class="o">%</span> <span class="nx">base</span><span class="p">]</span>
    <span class="nx">output</span> <span class="o">+=</span> <span class="nx">charNext</span>
    <span class="nv">rand = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">rand</span> <span class="o">/</span> <span class="nx">base</span><span class="p">)</span>

  <span class="nx">output</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Register require.extension for .oj files in node</p></div></div><div class="code"><div class="wrapper"><span class="k">if</span> <span class="nx">require</span><span class="p">.</span><span class="nx">extensions</span>

  <span class="nv">coffee = </span><span class="nx">require</span> <span class="s">&#39;coffee-script&#39;</span>
  <span class="nv">fs = </span><span class="nx">require</span> <span class="k">new</span> <span class="nb">String</span><span class="p">(</span><span class="s">&#39;fs&#39;</span><span class="p">)</span> <span class="c1"># Hack to avoid pulling fs to client</span>

  <span class="nv">stripBOM = </span><span class="nf">(c) -&gt;</span> <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xFEFF</span> <span class="k">then</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">slice</span> <span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="nx">c</span>

  <span class="nv">isCS = </span><span class="nf">(code) -&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="o">!=</span> <span class="nx">code</span><span class="p">.</span><span class="nx">search</span> <span class="sr">/(^\s*#|\n\s*#|-\&gt;)/</span>
  <span class="nv">isJS = </span><span class="nf">(code) -&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="o">!=</span> <span class="nx">code</span><span class="p">.</span><span class="nx">search</span> <span class="sr">/var|function|((^|\n)\s*\/\/)/</span>

  <span class="nx">require</span><span class="p">.</span><span class="nx">extensions</span><span class="p">[</span><span class="s">&#39;.oj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nf">(module, filepath) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Compile as coffee-script or javascript</p></div></div><div class="code"><div class="wrapper">    <span class="nv">code = </span><span class="nx">stripBOM</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span> <span class="nx">filepath</span><span class="p">,</span> <span class="s">&#39;utf8&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Transform into coffee script if necessary</p></div></div><div class="code"><div class="wrapper">    <span class="k">try</span>
      <span class="nv">code = </span><span class="nx">coffee</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">code</span><span class="p">,</span> <span class="nv">bare: </span><span class="kc">true</span>

    <span class="k">catch</span> <span class="nx">eCoffee</span>

      <span class="nv">eCoffee.message = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">oj</span><span class="p">.</span><span class="nx">codes</span><span class="o">?</span><span class="p">.</span><span class="nx">red</span><span class="si">}</span><span class="s">coffee-script error in </span><span class="si">#{</span><span class="nx">filepath</span><span class="si">}</span><span class="s">: </span><span class="si">#{</span><span class="nx">eCoffee</span><span class="p">.</span><span class="nx">message</span><span class="si">}#{</span><span class="nx">oj</span><span class="p">.</span><span class="nx">codes</span><span class="o">?</span><span class="p">.</span><span class="nx">reset</span><span class="si">}</span><span class="s">&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Report it as a coffee-script error if we are pretty
sure it is</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span><span class="nx">isCS</span> <span class="nx">code</span><span class="p">)</span> <span class="o">or</span> <span class="o">not</span> <span class="p">(</span><span class="nx">isJS</span> <span class="nx">code</span><span class="p">)</span>
        <span class="k">throw</span> <span class="nx">eCoffee</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Compile javascript</p></div></div><div class="code"><div class="wrapper">    <span class="k">try</span>
      <span class="nv">code = </span><span class="s">&quot;(function(){with(require(&#39;oj&#39;)){</span><span class="si">#{</span><span class="nx">code</span><span class="si">}</span><span class="s">}}).call(this);&quot;</span>
      <span class="nx">module</span><span class="p">.</span><span class="nx">_compile</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">filepath</span>

    <span class="k">catch</span> <span class="nx">eJS</span>

      <span class="nv">eJS.message = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">oj</span><span class="p">.</span><span class="nx">codes</span><span class="o">?</span><span class="p">.</span><span class="nx">red</span><span class="si">}</span><span class="s">javascript error in </span><span class="si">#{</span><span class="nx">filepath</span><span class="si">}</span><span class="s">: </span><span class="si">#{</span><span class="nx">eJS</span><span class="p">.</span><span class="nx">message</span><span class="si">}#{</span><span class="nx">oj</span><span class="p">.</span><span class="nx">codes</span><span class="o">?</span><span class="p">.</span><span class="nx">reset</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="k">throw</span> <span class="nx">eJS</span>

<span class="nv">root = </span><span class="nx">@</span>

<span class="nv">oj.version = </span><span class="s">&#39;0.0.7&#39;</span>

<span class="nv">oj.isClient = </span><span class="kc">true</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Export for NodeJS if necessary</p></div></div><div class="code"><div class="wrapper"><span class="k">if</span> <span class="k">typeof</span> <span class="nx">module</span> <span class="o">!=</span> <span class="s">&#39;undefined&#39;</span>
  <span class="nv">exports = module.exports = </span><span class="nx">oj</span>
<span class="k">else</span>
  <span class="nx">root</span><span class="p">[</span><span class="s">&#39;oj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">oj</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="type-helpers">Type Helpers</h2>

<p>Based on <a href="http://underscorejs.org/">underscore.js</a>
The potential duplication saddens me but oj needs sophisticated type detection</p></div></div><div class="code"><div class="wrapper"><span class="nv">oj.isUndefined = </span><span class="nf">(obj) -&gt;</span> <span class="nx">obj</span> <span class="o">==</span> <span class="kc">undefined</span>
<span class="nv">oj.isBoolean = </span><span class="nf">(obj) -&gt;</span> <span class="nx">obj</span> <span class="o">==</span> <span class="kc">true</span> <span class="o">or</span> <span class="nx">obj</span> <span class="o">==</span> <span class="kc">false</span> <span class="o">or</span> <span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;[object Boolean]&#39;</span>
<span class="nv">oj.isNumber = </span><span class="nf">(obj) -&gt;</span> <span class="o">!!</span><span class="p">(</span><span class="nx">obj</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">or</span> <span class="p">(</span><span class="nx">obj</span> <span class="o">and</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">toExponential</span> <span class="o">and</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">))</span>
<span class="nv">oj.isString = </span><span class="nf">(obj) -&gt;</span> <span class="o">!!</span><span class="p">(</span><span class="nx">obj</span> <span class="o">==</span> <span class="s">&#39;&#39;</span> <span class="o">or</span> <span class="p">(</span><span class="nx">obj</span> <span class="o">and</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">charCodeAt</span> <span class="o">and</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">substr</span><span class="p">))</span>
<span class="nv">oj.isDate = </span><span class="nf">(obj) -&gt;</span> <span class="o">!!</span><span class="p">(</span><span class="nx">obj</span> <span class="o">and</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">getTimezoneOffset</span> <span class="o">and</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">setUTCFullYear</span><span class="p">)</span>
<span class="nv">oj.isFunction = </span><span class="nf">(obj) -&gt;</span> <span class="k">typeof</span> <span class="nx">obj</span> <span class="o">==</span> <span class="s">&#39;function&#39;</span>
<span class="nv">oj.isArray = </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span> <span class="o">or</span> <span class="nf">(obj) -&gt;</span> <span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;[object Array]&#39;</span>
<span class="nv">oj.isRegEx = </span><span class="nf">(obj) -&gt;</span> <span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;[object RegExp]&#39;</span>
<span class="nv">oj.isDOM = </span><span class="nf">(obj) -&gt;</span> <span class="o">!!</span><span class="p">(</span><span class="nx">obj</span> <span class="o">and</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">nodeType</span><span class="o">?</span><span class="p">)</span>
<span class="nv">oj.isDOMElement = </span><span class="nf">(obj) -&gt;</span> <span class="o">!!</span><span class="p">(</span><span class="nx">obj</span> <span class="o">and</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<span class="nv">oj.isDOMAttribute = </span><span class="nf">(obj) -&gt;</span> <span class="o">!!</span><span class="p">(</span><span class="nx">obj</span> <span class="o">and</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
<span class="nv">oj.isDOMText = </span><span class="nf">(obj) -&gt;</span> <span class="o">!!</span><span class="p">(</span><span class="nx">obj</span> <span class="o">and</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
<span class="nv">oj.isjQuery = </span><span class="nf">(obj) -&gt;</span> <span class="o">!!</span><span class="p">(</span><span class="nx">obj</span> <span class="o">and</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">jquery</span><span class="p">)</span>
<span class="nv">oj.isBackbone = </span><span class="nf">(obj) -&gt;</span> <span class="o">!!</span><span class="p">(</span><span class="nx">obj</span> <span class="o">and</span> <span class="nx">obj</span><span class="p">.</span><span class="kc">on</span> <span class="o">and</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">trigger</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isOJ</span> <span class="nx">obj</span><span class="p">)</span>
<span class="nv">oj.isOJ = </span><span class="nf">(obj) -&gt;</span> <span class="o">!!</span><span class="p">(</span><span class="nx">obj</span><span class="o">?</span><span class="p">.</span><span class="nx">isOJ</span><span class="p">)</span>
<span class="nv">oj.isArguments = </span><span class="nf">(obj) -&gt;</span> <span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;[object Arguments]&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="utility-helpers">Utility: Helpers</h2>

<p>Some are from <a href="http://underscorejs.org/">underscore.js</a>.</p></div></div><div class="code"><div class="wrapper"><span class="nv">ArrayP = </span><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span>
<span class="nv">FuncP = </span><span class="nb">Function</span><span class="p">.</span><span class="nx">prototype</span>
<span class="nv">ObjP = </span><span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span>

<span class="nv">slice = </span><span class="nx">ArrayP</span><span class="p">.</span><span class="nx">slice</span>
<span class="nv">unshift = </span><span class="nx">ArrayP</span><span class="p">.</span><span class="nx">unshift</span>

<span class="nv">oj.__ = _ = </span><span class="p">{}</span>
<span class="nv">_.isCapitalLetter = </span><span class="nf">(c) -&gt;</span> <span class="o">!!</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">match</span> <span class="sr">/[A-Z]/</span><span class="p">)</span>
<span class="nv">_.identity = </span><span class="nf">(v) -&gt;</span> <span class="nx">v</span>
<span class="nv">_.property = </span><span class="nf">(obj, options = {}) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>_.defaults options, configurable: false</p></div></div><div class="code"><div class="wrapper">  <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">options</span>
<span class="nv">_.has = </span><span class="nf">(obj, key) -&gt;</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
<span class="nv">_.keys = </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span> <span class="o">||</span> <span class="nf">(obj) -&gt;</span>
  <span class="k">throw</span> <span class="s">&#39;Invalid object&#39;</span> <span class="k">if</span> <span class="nx">obj</span> <span class="o">!=</span> <span class="nb">Object</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
  <span class="nv">keys = </span><span class="p">[];</span>
  <span class="k">for</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">obj</span>
    <span class="k">if</span> <span class="nx">_has</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">key</span>
      <span class="nx">keys</span><span class="p">[</span><span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="o">=</span> <span class="nx">key</span><span class="p">;</span>
  <span class="nx">keys</span>
<span class="nv">_.values = </span><span class="nf">(obj) -&gt;</span>
  <span class="k">throw</span> <span class="s">&#39;Invalid object&#39;</span> <span class="k">if</span> <span class="nx">obj</span> <span class="o">!=</span> <span class="nb">Object</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
  <span class="nv">out = </span><span class="p">[]</span>
  <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">obj</span><span class="p">,</span> <span class="nf">(v) -&gt;</span> <span class="nx">out</span><span class="p">.</span><span class="nx">push</span> <span class="nx">v</span>
  <span class="nx">out</span>

<span class="nv">_.flatten = </span><span class="nf">(array, shallow) -&gt;</span>
  <span class="nx">_</span><span class="p">.</span><span class="nx">reduce</span> <span class="nx">array</span><span class="p">,</span> <span class="p">(</span><span class="nf">(memo, value) -&gt;</span>
    <span class="k">if</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">value</span>
      <span class="k">return</span> <span class="nx">memo</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="k">if</span> <span class="nx">shallow</span> <span class="k">then</span> <span class="nx">value</span> <span class="k">else</span> <span class="nx">_</span><span class="p">.</span><span class="nx">flatten</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span>
    <span class="nx">memo</span><span class="p">[</span><span class="nx">memo</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>
    <span class="nx">memo</span>
  <span class="p">),</span> <span class="p">[]</span>

<span class="nv">_.reduce = </span><span class="nf">(obj = [], iterator, memo, context) -&gt;</span>
  <span class="nv">initial = </span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">2</span>
  <span class="k">if</span> <span class="nx">ArrayP</span><span class="p">.</span><span class="nx">reduce</span> <span class="o">and</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">reduce</span> <span class="o">==</span> <span class="nx">ArrayP</span><span class="p">.</span><span class="nx">reduce</span>
    <span class="k">if</span> <span class="nx">context</span>
      <span class="nv">iterator = </span><span class="nx">_</span><span class="p">.</span><span class="nx">bind</span> <span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">initial</span> <span class="k">then</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">reduce</span> <span class="nx">iterator</span><span class="p">,</span> <span class="nx">memo</span> <span class="k">else</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">reduce</span> <span class="nx">iterator</span>

  <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">obj</span><span class="p">,</span> <span class="nf">(value, index, list) -&gt;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">initial</span><span class="p">)</span>
      <span class="nv">memo = </span><span class="nx">value</span>
      <span class="nv">initial = </span><span class="kc">true</span>
    <span class="k">else</span>
      <span class="nv">memo = </span><span class="nx">iterator</span><span class="p">.</span><span class="nx">call</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">memo</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">list</span>

  <span class="k">if</span> <span class="o">!</span><span class="nx">initial</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span> <span class="s">&#39;Reduce of empty array with no initial value&#39;</span>
  <span class="nx">memo</span>

  <span class="nv">ctor = </span><span class="o">-&gt;</span>
  <span class="nv">_.bind = </span><span class="nf">(func, context) -&gt;</span>
    <span class="k">if</span> <span class="nx">func</span><span class="p">.</span><span class="nx">bind</span> <span class="o">==</span> <span class="nx">FuncP</span><span class="p">.</span><span class="nx">bind</span> <span class="o">and</span> <span class="nx">FuncP</span><span class="p">.</span><span class="nx">bind</span>
      <span class="k">return</span> <span class="nx">FuncP</span><span class="p">.</span><span class="nx">bind</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">func</span><span class="p">,</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span> <span class="nx">unless</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">func</span><span class="p">)</span>
    <span class="nv">args = </span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span> <span class="nx">arguments</span><span class="p">,</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="nv">bound = </span><span class="o">-&gt;</span>
      <span class="nx">unless</span> <span class="k">this</span> <span class="k">instanceof</span> <span class="nx">bound</span>
        <span class="k">return</span> <span class="nx">func</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span> <span class="nx">arguments</span><span class="p">)</span>
      <span class="nv">ctor.prototype = </span><span class="nx">func</span><span class="p">.</span><span class="nx">prototype</span>
      <span class="nv">self = </span><span class="k">new</span> <span class="nx">ctor</span>
      <span class="nv">result = </span><span class="nx">func</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">self</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">))</span>
      <span class="k">if</span> <span class="nb">Object</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="o">==</span> <span class="nx">result</span>
        <span class="k">return</span> <span class="nx">result</span>
      <span class="nx">self</span>


<span class="nv">_.sortedIndex = </span><span class="nf">(array, obj, iterator = _.identity) -&gt;</span>
  <span class="nv">low = </span><span class="mi">0</span>
  <span class="nv">high = </span><span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="k">while</span> <span class="nx">low</span> <span class="o">&lt;</span> <span class="nx">high</span>
    <span class="nv">mid = </span><span class="p">(</span><span class="nx">low</span> <span class="o">+</span> <span class="nx">high</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span> <span class="nx">iterator</span><span class="p">(</span><span class="nx">array</span><span class="p">[</span><span class="nx">mid</span><span class="p">])</span> <span class="o">&lt;</span> <span class="nx">iterator</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="k">then</span> <span class="nv">low = </span><span class="nx">mid</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">else</span> <span class="nv">high = </span><span class="nx">mid</span><span class="p">;</span>
  <span class="nx">low</span>

<span class="nv">_.indexOf = </span><span class="nf">(array, item, isSorted) -&gt;</span>
  <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="nx">unless</span> <span class="nx">array</span><span class="o">?</span>
  <span class="k">if</span> <span class="nx">isSorted</span>
    <span class="nv">i = </span><span class="nx">_</span><span class="p">.</span><span class="nx">sortedIndex</span> <span class="nx">array</span><span class="p">,</span> <span class="nx">item</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">==</span> <span class="nx">item</span> <span class="k">then</span> <span class="nx">i</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">ArrayP</span><span class="p">.</span><span class="nx">indexOf</span> <span class="o">&amp;&amp;</span> <span class="nx">array</span><span class="p">.</span><span class="nx">indexOf</span> <span class="o">==</span> <span class="nx">ArrayP</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">array</span><span class="p">.</span><span class="nx">indexOf</span> <span class="nx">item</span>
  <span class="k">for</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">array</span>
    <span class="k">if</span> <span class="nx">v</span> <span class="o">==</span> <span class="nx">item</span>
      <span class="k">return</span> <span class="nx">i</span>
  <span class="o">-</span><span class="mi">1</span>

<span class="nv">_.toArray = </span><span class="nf">(obj) -&gt;</span>
  <span class="k">return</span> <span class="p">[]</span> <span class="k">if</span> <span class="o">!</span><span class="nx">obj</span>
  <span class="k">return</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span> <span class="nx">obj</span> <span class="k">if</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">obj</span>
  <span class="k">return</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span> <span class="nx">obj</span> <span class="k">if</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isArguments</span> <span class="nx">obj</span>
  <span class="k">return</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">toArray</span><span class="p">()</span> <span class="k">if</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">toArray</span> <span class="o">and</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">toArray</span><span class="p">)</span>
  <span class="nx">_</span><span class="p">.</span><span class="nx">values</span> <span class="nx">obj</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="-create">_.create</h2>

<p>Abstract Object.create for older browsers</p>

<p>Define this once to improve performance in older browsers</p></div></div><div class="code"><div class="wrapper"><span class="nv">F = </span><span class="o">-&gt;</span>
<span class="nv">_.create =</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check for existing native / shimmed Object.create</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="k">typeof</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span> <span class="o">==</span> <span class="s">&quot;function&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>found native/shim, so use it</p></div></div><div class="code"><div class="wrapper">    <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Based on Crockford shim</p></div></div><div class="code"><div class="wrapper">  <span class="k">else</span>
    <span class="nf">(o) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set the prototype of the function
so we will get <code>o</code> as the prototype
of the new object instance</p></div></div><div class="code"><div class="wrapper">      <span class="nv">F.prototype = </span><span class="nx">o</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>create a new object that inherits from
the <code>o</code> parameter</p></div></div><div class="code"><div class="wrapper">      <span class="nv">child = </span><span class="k">new</span> <span class="nx">F</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>clean up just in case o is really large</p></div></div><div class="code"><div class="wrapper">      <span class="nv">F.prototype = </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>send it back</p></div></div><div class="code"><div class="wrapper">      <span class="nx">child</span>

<span class="nv">_.getPrototypeOf =</span>
  <span class="k">if</span> <span class="k">typeof</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">getPrototypeOf</span> <span class="o">==</span> <span class="s">&quot;function&quot;</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">getPrototypeOf</span>
  <span class="k">else</span>
    <span class="nf">(o) -&gt;</span> <span class="nx">o</span><span class="p">.</span><span class="nx">proto</span> <span class="o">||</span> <span class="nx">o</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">prototype</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Determine if object or array is empty</p></div></div><div class="code"><div class="wrapper"><span class="nv">_.isEmpty = </span><span class="nf">(obj) -&gt;</span>
  <span class="k">return</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">if</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">obj</span>
  <span class="k">for</span> <span class="nx">k</span> <span class="k">of</span> <span class="nx">obj</span>
    <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">has</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">k</span>
      <span class="k">return</span> <span class="kc">false</span>
  <span class="kc">true</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>typeOf: Mimic behavior of built-in typeof operator and integrate jQuery, Backbone, and OJ types</p></div></div><div class="code"><div class="wrapper"><span class="nv">oj.typeOf = </span><span class="nf">(any) -&gt;</span>

  <span class="k">return</span> <span class="s">&#39;null&#39;</span> <span class="k">if</span> <span class="nx">any</span> <span class="o">==</span> <span class="kc">null</span>
  <span class="nv">t = </span><span class="k">typeof</span> <span class="nx">any</span>
  <span class="k">if</span> <span class="nx">t</span> <span class="o">==</span> <span class="s">&#39;object&#39;</span>
    <span class="k">if</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">any</span>               <span class="k">then</span> <span class="nv">t = </span><span class="s">&#39;array&#39;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isOJ</span> <span class="nx">any</span>             <span class="k">then</span> <span class="nv">t = </span><span class="nx">any</span><span class="p">.</span><span class="nx">type</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isRegEx</span> <span class="nx">any</span>          <span class="k">then</span> <span class="nv">t = </span><span class="s">&#39;regexp&#39;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isDate</span> <span class="nx">any</span>            <span class="k">then</span> <span class="nv">t = </span><span class="s">&#39;date&#39;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isDOMElement</span> <span class="nx">any</span>     <span class="k">then</span> <span class="nv">t = </span><span class="s">&#39;element&#39;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isDOMText</span> <span class="nx">any</span>        <span class="k">then</span> <span class="nv">t = </span><span class="s">&#39;text&#39;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isDOMAttribute</span> <span class="nx">any</span>   <span class="k">then</span> <span class="nv">t = </span><span class="s">&#39;attribute&#39;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isBackbone</span> <span class="nx">any</span>       <span class="k">then</span> <span class="nv">t = </span><span class="s">&#39;backbone&#39;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isjQuery</span> <span class="nx">any</span>         <span class="k">then</span> <span class="nv">t = </span><span class="s">&#39;jquery&#39;</span>
    <span class="k">else</span>                            <span class="nv">t = </span><span class="s">&#39;object&#39;</span>
  <span class="nx">t</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Determine if obj is a vanilla object</p></div></div><div class="code"><div class="wrapper"><span class="nv">oj.isObject = </span><span class="nf">(obj) -&gt;</span> <span class="p">(</span><span class="nx">oj</span><span class="p">.</span><span class="nx">typeOf</span> <span class="nx">obj</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;object&#39;</span>

<span class="nv">_.clone = </span><span class="nf">(obj) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>TODO: support cloning OJ instances
TODO: support options, deep: true</p></div></div><div class="code"><div class="wrapper">  <span class="k">return</span> <span class="nx">obj</span> <span class="nx">unless</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isObject</span> <span class="nx">obj</span>
  <span class="k">if</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">obj</span> <span class="k">then</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">slice</span><span class="p">()</span> <span class="k">else</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="p">{},</span> <span class="nx">obj</span>

<span class="nv">oj.enum = </span><span class="nf">(name, args) -&gt;</span>
  <span class="k">throw</span> <span class="s">&#39;NYI&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="utility-iteration">Utility: Iteration</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>_each(collection, iterator, context)</p>

<pre><code>Iterate over collection or function. If a function
is encountered it is evaluated before iteration

collection    Array or Object to iterate over
iterator      Function to call on each step
context       (Optional) Object to pass as 'this' to iteration method
</code></pre></div></div><div class="code"><div class="wrapper"><span class="nv">_.breaker = </span><span class="p">{}</span>
<span class="nv">_.each = </span><span class="nf">(col, iterator, context) -&gt;</span>

  <span class="k">return</span> <span class="k">if</span> <span class="nx">col</span> <span class="o">==</span> <span class="kc">null</span>
  <span class="k">if</span> <span class="nx">ArrayP</span><span class="p">.</span><span class="nx">forEach</span> <span class="o">and</span> <span class="nx">col</span><span class="p">.</span><span class="nx">forEach</span> <span class="o">==</span> <span class="nx">ArrayP</span><span class="p">.</span><span class="nx">forEach</span>
    <span class="nx">col</span><span class="p">.</span><span class="nx">forEach</span> <span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span>
  <span class="k">else</span> <span class="k">if</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">col</span>
    <span class="k">for</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">col</span>
      <span class="k">if</span> <span class="nx">iterator</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">col</span><span class="p">)</span> <span class="o">==</span> <span class="nx">_</span><span class="p">.</span><span class="nx">breaker</span>
        <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">breaker</span>
  <span class="k">else</span>
    <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">col</span>
      <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">has</span> <span class="nx">col</span><span class="p">,</span> <span class="nx">k</span>
        <span class="k">if</span> <span class="nx">iterator</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">col</span><span class="p">)</span> <span class="o">==</span> <span class="nx">_</span><span class="p">.</span><span class="nx">breaker</span>
          <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">breaker</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>_.map(collection, iterator, options = {})</p>

<pre><code>Map over object or array If a function
is encountered it is evaluated before iteration

collection    Array or Object to iterate over
iterator      Function to call on each step
options
  context       (Optional) Object to pass as 'this' to iteration method
  context       (Optional) Boolean indicating  to pass as 'this' to iteration method
</code></pre></div></div><div class="code"><div class="wrapper"><span class="nv">_.map = </span><span class="nf">(obj, iterator, options = {}) -&gt;</span>

  <span class="nv">context = </span><span class="nx">options</span><span class="p">.</span><span class="nx">context</span>
  <span class="nv">recurse = </span><span class="nx">options</span><span class="p">.</span><span class="nx">recurse</span>
  <span class="nv">evaluate = </span><span class="nx">options</span><span class="p">.</span><span class="nx">evaluate</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Recurse if necessary</p></div></div><div class="code"><div class="wrapper">  <span class="nv">iterator_ = </span><span class="nx">iterator</span>
  <span class="k">if</span> <span class="nx">recurse</span>
    <span class="nx">do</span> <span class="nf">(options) -&gt;</span>
      <span class="nv">iterator_ = </span><span class="nf">(v,k,o) -&gt;</span>
        <span class="nv">options_ = </span><span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">clone</span> <span class="nx">options</span><span class="p">),</span> <span class="p">(</span><span class="nv">key: </span><span class="nx">k</span><span class="p">,</span> <span class="nv">object: </span><span class="nx">v</span><span class="p">)</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">map</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">iterator</span><span class="p">,</span> <span class="nx">options_</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Evaluate functions if necessary</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isFunction</span> <span class="nx">obj</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Functions pass through if evaluate isn't set</p></div></div><div class="code"><div class="wrapper">    <span class="k">return</span> <span class="nx">obj</span> <span class="nx">unless</span> <span class="nx">evaluate</span>

    <span class="k">while</span> <span class="nx">evaluate</span> <span class="o">and</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isFunction</span> <span class="nx">obj</span>
      <span class="nv">obj = </span><span class="nx">obj</span><span class="p">()</span>

  <span class="nv">out = </span><span class="nx">obj</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Array case</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">obj</span>
    <span class="nv">out = </span><span class="p">[]</span>
    <span class="k">return</span> <span class="nx">out</span> <span class="nx">unless</span> <span class="nx">obj</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">map</span> <span class="nx">iterator_</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="k">if</span> <span class="nx">ArrayP</span><span class="p">.</span><span class="nx">map</span> <span class="o">and</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">map</span> <span class="o">==</span> <span class="nx">ArrayP</span><span class="p">.</span><span class="nx">map</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="p">(</span><span class="nf">(v, ix, list) -&gt;</span>
      <span class="nx">out</span><span class="p">[</span><span class="nx">out</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="o">=</span> <span class="nx">iterator_</span><span class="p">.</span><span class="nx">call</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">ix</span><span class="p">,</span> <span class="nx">list</span>
    <span class="p">))</span>

    <span class="k">if</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="o">+</span><span class="nx">obj</span><span class="p">.</span><span class="nx">length</span>
      <span class="nv">out.length = </span><span class="nx">obj</span><span class="p">.</span><span class="nx">length</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Object case</p></div></div><div class="code"><div class="wrapper">  <span class="k">else</span> <span class="k">if</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isObject</span> <span class="nx">obj</span>
    <span class="nv">out = </span><span class="p">{}</span>
    <span class="k">return</span> <span class="nx">out</span> <span class="nx">unless</span> <span class="nx">obj</span>
    <span class="k">for</span> <span class="nx">k</span><span class="p">,</span><span class="nx">v</span> <span class="k">of</span> <span class="nx">obj</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Returning undefined will omit the thing</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span><span class="nv">r = </span><span class="nx">iterator_</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">obj</span><span class="p">))</span> <span class="o">!=</span> <span class="kc">undefined</span>
        <span class="nx">out</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">r</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Basis of recursive case</p></div></div><div class="code"><div class="wrapper">  <span class="k">else</span>
    <span class="k">return</span> <span class="nx">iterator</span><span class="p">.</span><span class="nx">call</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">object</span><span class="p">,</span>
  <span class="nx">out</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>_.extend</p></div></div><div class="code"><div class="wrapper"><span class="nv">_.extend = </span><span class="nf">(obj) -&gt;</span>
  <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="nf">(source) -&gt;</span>
    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">source</span>
      <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>
  <span class="p">))</span>
  <span class="nx">obj</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>_.defaults</p></div></div><div class="code"><div class="wrapper"><span class="nv">_.defaults = </span><span class="nf">(obj) -&gt;</span>
  <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="nf">(source) -&gt;</span>
    <span class="k">for</span> <span class="nx">prop</span> <span class="k">of</span> <span class="nx">source</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span><span class="o">?</span>
        <span class="nx">obj</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="nx">source</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span>
  <span class="p">))</span>
  <span class="nx">obj</span>

<span class="nv">_.uniqueSort = </span><span class="nf">(array, isSorted = false) -&gt;</span>
  <span class="k">if</span> <span class="o">not</span> <span class="nx">isSorted</span>
    <span class="nx">array</span><span class="p">.</span><span class="nx">sort</span><span class="p">()</span>
  <span class="nv">out = </span><span class="p">[]</span>
  <span class="k">for</span> <span class="nx">item</span><span class="p">,</span><span class="nx">ix</span> <span class="k">in</span> <span class="nx">array</span>
    <span class="k">if</span> <span class="nx">ix</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">array</span><span class="p">[</span><span class="nx">ix</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="nx">array</span><span class="p">[</span><span class="nx">ix</span><span class="p">]</span>
      <span class="k">continue</span>
    <span class="nx">out</span><span class="p">.</span><span class="nx">push</span> <span class="nx">item</span>
  <span class="nx">out</span>

<span class="nv">_.uniqueSortedUnion = </span><span class="nf">(array, array2) -&gt;</span>
  <span class="nx">_</span><span class="p">.</span><span class="nx">uniqueSort</span> <span class="p">(</span><span class="nx">array</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">array2</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="ojaddmethod">oj.addMethod</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="nv">oj.addMethods = </span><span class="nf">(obj, mapNameToMethod) -&gt;</span>
  <span class="k">for</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">method</span> <span class="k">of</span> <span class="nx">mapNameToMethod</span>
    <span class="nx">oj</span><span class="p">.</span><span class="nx">addMethod</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">method</span>
  <span class="k">return</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="ojaddmethod">oj.addMethod</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="nv">oj.addMethod = </span><span class="nf">(obj, methodName, method) -&gt;</span>
  <span class="k">throw</span> <span class="s">&#39;oj.addMethod: string expected for second argument&#39;</span> <span class="nx">unless</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isString</span> <span class="nx">methodName</span>
  <span class="k">throw</span> <span class="s">&#39;oj.addMethod: function expected for thrid argument&#39;</span> <span class="nx">unless</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isFunction</span> <span class="nx">method</span>
  <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">methodName</span><span class="p">,</span>
    <span class="nv">value: </span><span class="nx">method</span>
    <span class="nv">enumerable: </span><span class="kc">false</span>
    <span class="nv">writable: </span><span class="kc">false</span>
    <span class="nv">configurable: </span><span class="kc">true</span>
  <span class="k">return</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="ojremovemethod">oj.removeMethod</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="nv">oj.removeMethod = </span><span class="nf">(obj, methodName) -&gt;</span>
  <span class="k">throw</span> <span class="s">&#39;oj.removeMethod: string expected for second argument&#39;</span> <span class="nx">unless</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isString</span> <span class="nx">methodName</span>
  <span class="k">delete</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">methodName</span><span class="p">]</span>
  <span class="k">return</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="ojaddproperties">oj.addProperties</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="nv">oj.addProperties = </span><span class="nf">(obj, mapNameToInfo) -&gt;</span>

  <span class="k">for</span> <span class="nx">propName</span><span class="p">,</span> <span class="nx">propInfo</span> <span class="k">of</span> <span class="nx">mapNameToInfo</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prop value may be specified by an object with a get/set or by value
Examples:
  age: 7    # defaults to {writable:true, enumerable:true}
  age: {value:7, writable:false, enumerable:false}
  age: {get:(-> 7), enumerable:false}</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Wrap the value if propInfo is not already a property definition</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="o">not</span> <span class="nx">propInfo</span><span class="o">?</span><span class="p">.</span><span class="nx">get</span><span class="o">?</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">propInfo</span><span class="o">?</span><span class="p">.</span><span class="nx">value</span><span class="o">?</span>
      <span class="nv">propInfo = value: </span><span class="nx">propInfo</span>

    <span class="nx">oj</span><span class="p">.</span><span class="nx">addProperty</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">propName</span><span class="p">,</span> <span class="nx">propInfo</span>

  <span class="k">return</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="ojaddproperty">oj.addProperty</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="nv">oj.addProperty = </span><span class="nf">(obj, propName, propInfo) -&gt;</span>
  <span class="k">throw</span> <span class="s">&#39;oj.addProperty: string expected for second argument&#39;</span> <span class="nx">unless</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isString</span> <span class="nx">propName</span>
  <span class="k">throw</span> <span class="s">&#39;oj.addProperty: object expected for third argument&#39;</span> <span class="nx">unless</span> <span class="p">(</span><span class="nx">oj</span><span class="p">.</span><span class="nx">isObject</span> <span class="nx">propInfo</span><span class="p">)</span>
  <span class="k">throw</span> <span class="s">&#39;oj.addProperty: get or value key expected in third argument&#39;</span> <span class="nx">unless</span> <span class="p">(</span><span class="nx">propInfo</span><span class="p">.</span><span class="nx">get</span><span class="o">?</span> <span class="o">or</span> <span class="nx">propInfo</span><span class="p">.</span><span class="nx">value</span><span class="o">?</span><span class="p">)</span>

  <span class="nx">_</span><span class="p">.</span><span class="nx">defaults</span> <span class="nx">propInfo</span><span class="p">,</span>
    <span class="nv">enumerable: </span><span class="kc">true</span>
    <span class="nv">configurable: </span><span class="kc">true</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Remove property if it already exists</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">propName</span><span class="p">]</span><span class="o">?</span>
    <span class="nx">oj</span><span class="p">.</span><span class="nx">removeProperty</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">propName</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add the property</p></div></div><div class="code"><div class="wrapper">  <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">propName</span><span class="p">,</span> <span class="nx">propInfo</span>
  <span class="k">return</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="ojremoveproperty">oj.removeProperty</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="nv">oj.removeProperty = </span><span class="nf">(obj, propName) -&gt;</span>
  <span class="k">throw</span> <span class="s">&#39;oj.addProperty: string expected for second argument&#39;</span> <span class="nx">unless</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isString</span> <span class="nx">propName</span>
  <span class="k">delete</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">propName</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="ojisproperty">oj.isProperty</h2>

<p>Determine if the specified key is was defined by addProperty</p></div></div><div class="code"><div class="wrapper"><span class="nv">oj.isProperty = </span><span class="nf">(obj, propName) -&gt;</span>
  <span class="k">throw</span> <span class="s">&#39;oj.isProperty: string expected for second argument&#39;</span> <span class="nx">unless</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isString</span> <span class="nx">propName</span>

  <span class="nb">Object</span><span class="p">.</span><span class="nx">getOwnPropertyDescriptor</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">propName</span><span class="p">).</span><span class="nx">get</span><span class="o">?</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="ojcopyproperty">oj.copyProperty</h2>

<p>Determine copy source.propName to dest.propName</p></div></div><div class="code"><div class="wrapper"><span class="nv">oj.copyProperty = </span><span class="nf">(dest, source, propName) -&gt;</span>
  <span class="nv">info = </span><span class="nb">Object</span><span class="p">.</span><span class="nx">getOwnPropertyDescriptor</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">propName</span>
  <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span> <span class="nx">dest</span><span class="p">,</span> <span class="nx">propName</span><span class="p">,</span> <span class="nx">info</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="-arguments">_.arguments</h2>

<p>Abstraction to wrap global arguments stack. This makes me sad but it is necessary for div -> syntax</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Stack of results</p></div></div><div class="code"><div class="wrapper"><span class="nv">_.argumentsStack = </span><span class="p">[]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Result is top of the stack</p></div></div><div class="code"><div class="wrapper"><span class="nx">oj</span><span class="p">.</span><span class="nx">addProperty</span> <span class="nx">_</span><span class="p">,</span> <span class="s">&#39;arguments&#39;</span><span class="p">,</span> <span class="nv">get: </span><span class="o">-&gt;</span> <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">argumentsStack</span><span class="p">.</span><span class="nx">length</span> <span class="k">then</span> <span class="nx">_</span><span class="p">.</span><span class="nx">argumentsStack</span><span class="p">[</span><span class="nx">_</span><span class="p">.</span><span class="nx">argumentsStack</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Push scope onto arguments</p></div></div><div class="code"><div class="wrapper"><span class="nv">_.argumentsPush = </span><span class="nf">(args = []) -&gt;</span>
  <span class="nx">_</span><span class="p">.</span><span class="nx">argumentsStack</span><span class="p">.</span><span class="nx">push</span> <span class="nx">args</span>
  <span class="k">return</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Pop scope from arguments</p></div></div><div class="code"><div class="wrapper"><span class="nv">_.argumentsPop = </span><span class="o">-&gt;</span>
  <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">argumentsStack</span><span class="p">.</span><span class="nx">length</span>
    <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">argumentsStack</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
  <span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Append argument</p></div></div><div class="code"><div class="wrapper"><span class="nv">_.argumentsAppend = </span><span class="nf">(arg) -&gt;</span>
  <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">arguments</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">push</span> <span class="nx">arg</span>
  <span class="k">return</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="ojtag-name-attributes-content-content-">oj.tag (name, attributes, content, content, ...)</h2>

<pre><code>name          String of the tag to serialize
attributes    (Optional) Object defining attributes of tag being serialized
              Keys have smart mappings:
                  'c'  will map to 'class'
                  'fontSize' will map to 'font-size'
                  'borderRadius' will map to 'moz-border-radius', etc.
</code></pre></div></div><div class="code"><div class="wrapper"><span class="nv">oj.tag = </span><span class="nf">(name, args...) -&gt;</span>
  <span class="k">throw</span> <span class="s">&#39;oj.tag error: argument 1 is not a string (expected tag name)&#39;</span> <span class="nx">unless</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isString</span> <span class="nx">name</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Build ojml starting with tag</p></div></div><div class="code"><div class="wrapper">  <span class="nv">ojml = </span><span class="p">[</span><span class="nx">name</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get attributes from args by unioning all objects</p></div></div><div class="code"><div class="wrapper">  <span class="nv">attributes = </span><span class="p">{}</span>
  <span class="k">for</span> <span class="nx">arg</span> <span class="k">in</span> <span class="nx">args</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>TODO: evaluate argument if necessary</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isObject</span> <span class="nx">arg</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">arg</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Help the attributes out as they have shitting</p></div></div><div class="code"><div class="wrapper">  <span class="nv">attributes = </span><span class="nx">_tagAttributes</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">attributes</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add attributes to ojml if they exist</p></div></div><div class="code"><div class="wrapper">  <span class="nx">ojml</span><span class="p">.</span><span class="nx">push</span> <span class="nx">attributes</span> <span class="nx">unless</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span> <span class="nx">attributes</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Push arguments to build up children tags</p></div></div><div class="code"><div class="wrapper">  <span class="nx">_</span><span class="p">.</span><span class="nx">argumentsPush</span> <span class="nx">ojml</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Loop over attributes</p></div></div><div class="code"><div class="wrapper">  <span class="k">for</span> <span class="nx">arg</span> <span class="k">in</span> <span class="nx">args</span>
    <span class="k">if</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isObject</span> <span class="nx">arg</span>
      <span class="k">continue</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isFunction</span> <span class="nx">arg</span>

      <span class="nv">len = </span><span class="nx">_</span><span class="p">.</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Call the argument it will auto append to _.arguments which is ojml</p></div></div><div class="code"><div class="wrapper">      <span class="nv">r = </span><span class="nx">arg</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Use return value if _.arguments weren't changed</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">len</span> <span class="o">==</span> <span class="nx">_</span><span class="p">.</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">and</span> <span class="nx">r</span><span class="o">?</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">argumentsAppend</span> <span class="nx">r</span>

    <span class="k">else</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">argumentsAppend</span> <span class="nx">arg</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Pop to restore previous context</p></div></div><div class="code"><div class="wrapper">  <span class="nx">_</span><span class="p">.</span><span class="nx">argumentsPop</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Append the final result to your parent's arguments
if there exists an argument to append to</p></div></div><div class="code"><div class="wrapper">  <span class="nx">_</span><span class="p">.</span><span class="nx">argumentsAppend</span> <span class="nx">ojml</span>

  <span class="nx">ojml</span>

<span class="nv">oj.tag.elements =</span>
  <span class="nv">closed: </span><span class="s">&#39;a abbr acronym address applet article aside audio b bdo big blockquote body button canvas caption center cite code colgroup command datalist dd del details dfn dir div dl dt em embed fieldset figcaption figure font footer form frameset h1 h2 h3 h4 h5 h6 head header hgroup html i iframe ins keygen kbd label legend li map mark menu meter nav noframes noscript object ol optgroup option output p pre progress q rp rt ruby s samp script section select small source span strike strong style sub summary sup table tbody td textarea tfoot th thead time title tr tt u ul var video wbr xmp&#39;</span><span class="p">.</span><span class="nx">split</span> <span class="s">&#39; &#39;</span>
  <span class="nv">open: </span><span class="s">&#39;area base br col command css embed hr img input keygen link meta param source track wbr&#39;</span><span class="p">.</span><span class="nx">split</span> <span class="s">&#39; &#39;</span>

<span class="nv">oj.tag.elements.all = </span><span class="p">(</span><span class="nx">oj</span><span class="p">.</span><span class="nx">tag</span><span class="p">.</span><span class="nx">elements</span><span class="p">.</span><span class="nx">closed</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">tag</span><span class="p">.</span><span class="nx">elements</span><span class="p">.</span><span class="nx">open</span><span class="p">).</span><span class="nx">sort</span><span class="p">()</span>

<span class="nv">oj.tag.isClosed = </span><span class="nf">(tag) -&gt;</span>
  <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">indexOf</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">tag</span><span class="p">.</span><span class="nx">elements</span><span class="p">.</span><span class="nx">open</span><span class="p">,</span> <span class="nx">tag</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create tag methods</p></div></div><div class="code"><div class="wrapper"><span class="k">for</span> <span class="nx">t</span> <span class="k">in</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">tag</span><span class="p">.</span><span class="nx">elements</span><span class="p">.</span><span class="nx">all</span>
  <span class="nx">do</span> <span class="nf">(t) -&gt;</span>
    <span class="nx">oj</span><span class="p">[</span><span class="nx">t</span><span class="p">]</span> <span class="o">=</span> <span class="o">-&gt;</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">tag</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">...</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Customize a few tags</p></div></div><div class="code"><div class="wrapper"><span class="nv">_defaultClear = </span><span class="nf">(dest, d, e) -&gt;</span>
  <span class="nx">_</span><span class="p">.</span><span class="nx">defaults</span> <span class="nx">dest</span><span class="p">,</span> <span class="nx">d</span>
  <span class="k">for</span> <span class="nx">k</span> <span class="k">of</span> <span class="nx">e</span>
    <span class="k">delete</span> <span class="nx">dest</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span>
  <span class="nx">dest</span>

<span class="nv">_tagAttributes = </span><span class="nf">(name, attributes) -&gt;</span>
  <span class="nv">attr = </span><span class="nx">_</span><span class="p">.</span><span class="nx">clone</span> <span class="nx">attributes</span>
  <span class="k">switch</span> <span class="nx">name</span>
    <span class="k">when</span> <span class="s">&#39;link&#39;</span> <span class="k">then</span> <span class="nx">_defaultClear</span> <span class="nx">attr</span><span class="p">,</span> <span class="p">{</span><span class="nx">rel</span><span class="o">:</span><span class="s">&#39;stylesheet&#39;</span><span class="p">,</span> <span class="nx">type</span><span class="o">:</span><span class="s">&#39;text/css&#39;</span><span class="p">,</span> <span class="nv">href: </span><span class="nx">attr</span><span class="p">.</span><span class="nx">url</span> <span class="o">or</span> <span class="nx">attr</span><span class="p">.</span><span class="nx">src</span><span class="p">},</span> <span class="p">{</span><span class="nx">url</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span> <span class="nx">src</span><span class="o">:</span><span class="mi">0</span><span class="p">}</span>
    <span class="k">when</span> <span class="s">&#39;script&#39;</span> <span class="k">then</span> <span class="nx">_defaultClear</span> <span class="nx">attr</span><span class="p">,</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span><span class="s">&#39;text/javascript&#39;</span><span class="p">,</span> <span class="nv">src: </span><span class="nx">attr</span><span class="p">.</span><span class="nx">url</span><span class="p">},</span> <span class="nx">url</span><span class="o">:</span><span class="mi">0</span>
    <span class="k">when</span> <span class="s">&#39;a&#39;</span> <span class="k">then</span> <span class="nx">_defaultClear</span> <span class="nx">attr</span><span class="p">,</span> <span class="p">{</span><span class="nx">href</span><span class="o">:</span><span class="nx">attr</span><span class="p">.</span><span class="nx">url</span><span class="p">},</span> <span class="nx">url</span><span class="o">:</span><span class="mi">0</span>
  <span class="nx">attr</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="ojpage">oj.page</h2>

<p>General template for oj to not need html, head, body tags</p></div></div><div class="code"><div class="wrapper"><span class="nv">oj.page = </span><span class="nf">(options, content) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Options is optional</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="o">not</span> <span class="nx">content</span><span class="o">?</span>
    <span class="nv">content = </span><span class="nx">options</span>
    <span class="nv">options = </span><span class="p">{}</span>

  <span class="nx">oj</span><span class="p">.</span><span class="nx">html</span> <span class="o">-&gt;</span>
    <span class="nx">oj</span><span class="p">.</span><span class="nx">head</span> <span class="o">-&gt;</span>
      <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">title</span><span class="o">?</span>
        <span class="nx">oj</span><span class="p">.</span><span class="nx">title</span> <span class="nx">options</span><span class="p">.</span><span class="nx">title</span>
    <span class="nx">oj</span><span class="p">.</span><span class="nx">body</span> <span class="o">-&gt;</span>
      <span class="nx">content</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>oj.styles = ()</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="ojextend-context">oj.extend (context)</h2>

<pre><code>Extend oj methods into a context. Common contexts are `global` `window`
and `this` (used in coffee script). Helper methods are not extended (oj._)

context          Object to extend oj methods and objects into
</code></pre></div></div><div class="code"><div class="wrapper"><span class="nv">oj.extend = </span><span class="nf">(context) -&gt;</span>
  <span class="nv">o = </span><span class="p">{}</span>
  <span class="k">for</span> <span class="nx">k</span><span class="p">,</span><span class="nx">v</span> <span class="k">of</span> <span class="nx">oj</span>
    <span class="k">if</span> <span class="nx">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;_&#39;</span>
      <span class="nx">o</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span>
  <span class="k">delete</span> <span class="nx">o</span><span class="p">.</span><span class="nx">extend</span>
  <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">o</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="ojcompile">oj.compile</h2>

<p>Compile ojml into meaningful parts
options
    html:true           Compile to html
    dom:true            Compile to dom
    css:true            Compile to css
    debug:true          Keep all source including comments
    ignore:{html:1}     Map of tags to ignore while compiling</p></div></div><div class="code"><div class="wrapper"><span class="nv">oj.compile = </span><span class="nf">(options, ojml) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Options is optional</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="o">not</span> <span class="nx">ojml</span><span class="o">?</span>
    <span class="nv">ojml = </span><span class="nx">options</span>
    <span class="nv">options = </span><span class="p">{}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Default options to compile everything</p></div></div><div class="code"><div class="wrapper">  <span class="nv">options = </span><span class="nx">_</span><span class="p">.</span><span class="nx">defaults</span> <span class="p">{},</span> <span class="nx">options</span><span class="p">,</span>
    <span class="nv">html: </span><span class="kc">true</span>
    <span class="nv">dom: </span><span class="kc">true</span>
    <span class="nv">css: </span><span class="kc">true</span>
    <span class="nv">debug: </span><span class="kc">false</span>
    <span class="nv">ignore: </span><span class="p">{}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Always ignore oj and css tags</p></div></div><div class="code"><div class="wrapper">  <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">options</span><span class="p">.</span><span class="nx">ignore</span><span class="p">,</span> <span class="nx">oj</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="nx">css</span><span class="o">:</span><span class="mi">1</span>

  <span class="nv">options.html = </span><span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">html</span> <span class="k">then</span> <span class="p">[]</span> <span class="k">else</span> <span class="kc">null</span>    <span class="c1"># html accumulator</span>
  <span class="nv">options.dom = </span><span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">dom</span> <span class="o">and</span> <span class="nb">document</span><span class="o">?</span> <span class="k">then</span> <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span> <span class="s">&#39;OJ&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">null</span>
  <span class="nv">options.css = </span><span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">css</span> <span class="k">then</span> <span class="p">{}</span> <span class="k">else</span> <span class="kc">null</span>      <span class="c1"># css accumulator</span>
  <span class="nv">options.indent = </span><span class="s">&#39;&#39;</span>                                 <span class="c1"># indent counter</span>
  <span class="nv">options.types = </span><span class="p">[]</span>                                  <span class="c1"># remember what types were used</span>
  <span class="nv">options.tags = </span><span class="p">{}</span>                                   <span class="c1"># remember what tags were used</span>

  <span class="nx">_compileAny</span> <span class="nx">ojml</span><span class="p">,</span> <span class="nx">options</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Generate css if necessary</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">css</span>
    <span class="nv">css = </span><span class="nx">_cssFromObject</span> <span class="nx">options</span><span class="p">.</span><span class="nx">css</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">debug</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Generate HTML if necessary</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">html</span><span class="o">?</span>
    <span class="nv">html = </span><span class="nx">options</span><span class="p">.</span><span class="nx">html</span><span class="p">.</span><span class="nx">join</span> <span class="s">&#39;&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Generate dom if necessary</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">dom</span><span class="o">?</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Remove the <oj> wrapping from the dom element</p></div></div><div class="code"><div class="wrapper">    <span class="nv">dom = </span><span class="nx">options</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">childNodes</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Cleanup inconsistencies of childNodes</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">dom</span><span class="p">.</span><span class="nx">length</span><span class="o">?</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Make dom a real array</p></div></div><div class="code"><div class="wrapper">      <span class="nv">dom = </span><span class="nx">_</span><span class="p">.</span><span class="nx">toArray</span> <span class="nx">dom</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Filter out anything that isn't a dom element</p></div></div><div class="code"><div class="wrapper">      <span class="nv">dom = </span><span class="nx">dom</span><span class="p">.</span><span class="nx">filter</span> <span class="nf">(v) -&gt;</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isDOM</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Ensure dom is null if empty</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">dom</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span>
      <span class="nv">dom = </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Single elements are returned themselves not as a list
Reasoning: The common cases don't have multiple elements <html>,<body>
or the complexity doesn't matter because insertion is abstracted for you
In short it is easier to check for _.isArray dom, then _isArray dom &amp;&amp; dom.length > 0</p></div></div><div class="code"><div class="wrapper">    <span class="k">else</span> <span class="k">if</span> <span class="nx">dom</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span>
      <span class="nv">dom = </span><span class="nx">dom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

  <span class="nv">out = </span><span class="nx">html</span><span class="o">:</span><span class="nx">html</span><span class="p">,</span> <span class="nx">dom</span><span class="o">:</span><span class="nx">dom</span><span class="p">,</span> <span class="nx">css</span><span class="o">:</span><span class="nx">css</span><span class="p">,</span> <span class="nx">types</span><span class="o">:</span><span class="nx">options</span><span class="p">.</span><span class="nx">types</span><span class="p">,</span> <span class="nx">tags</span><span class="o">:</span><span class="nx">options</span><span class="p">.</span><span class="nx">tags</span>

  <span class="nx">out</span>

<span class="nv">_styleKeyFromFancy = </span><span class="nf">(key) -&gt;</span>
  <span class="nv">out = </span><span class="s">&quot;&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Loop over characters in key looking for camal case</p></div></div><div class="code"><div class="wrapper">  <span class="k">for</span> <span class="nx">c</span> <span class="k">in</span> <span class="nx">key</span>
    <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isCapitalLetter</span> <span class="nx">c</span>
      <span class="nx">out</span> <span class="o">+=</span> <span class="s">&quot;-</span><span class="si">#{</span><span class="nx">c</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="k">else</span>
      <span class="nx">out</span> <span class="o">+=</span> <span class="nx">c</span>
  <span class="nx">out</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="-stylefromobject-convert-object-to-string-form">_styleFromObject: Convert object to string form</h2>

<pre><code>inline:false      inline:true                inline:false,indent:true
color:red;        color:red;font-size:10px   \tcolor:red;
font-size:10px;                              \tfont-size:10px;
</code></pre></div></div><div class="code"><div class="wrapper"><span class="nv">_styleFromObject = </span><span class="nf">(obj, options = {}) -&gt;</span>
  <span class="nx">_</span><span class="p">.</span><span class="nx">defaults</span> <span class="nx">options</span><span class="p">,</span>
    <span class="nv">inline: </span><span class="kc">true</span>
    <span class="nv">indent: </span><span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Trailing semi should only exist on when we aren't indenting</p></div></div><div class="code"><div class="wrapper">  <span class="nv">options.semi = </span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">inline</span>
  <span class="nv">out = </span><span class="s">&quot;&quot;</span>
  <span class="nv">keys = </span><span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">obj</span><span class="p">).</span><span class="nx">sort</span><span class="p">()</span>
  <span class="nv">indent = </span><span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">indent</span> <span class="k">then</span> <span class="s">&#39;\t&#39;</span> <span class="k">else</span> <span class="s">&#39;&#39;</span>
  <span class="nv">newline = </span><span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">inline</span> <span class="k">then</span> <span class="s">&#39;&#39;</span> <span class="k">else</span> <span class="s">&#39;\n&#39;</span>
  <span class="k">for</span> <span class="nx">kFancy</span><span class="p">,</span><span class="nx">ix</span> <span class="k">in</span> <span class="nx">keys</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add semi if it is not inline or it is not the last key</p></div></div><div class="code"><div class="wrapper">    <span class="nv">semi = </span><span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">semi</span> <span class="o">or</span> <span class="nx">ix</span> <span class="o">!=</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span> <span class="k">then</span> <span class="s">&quot;;&quot;</span> <span class="k">else</span> <span class="s">&#39;&#39;</span>
    <span class="nv">k = </span><span class="nx">_styleKeyFromFancy</span> <span class="nx">kFancy</span>
    <span class="nx">out</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">indent</span><span class="si">}#{</span><span class="nx">k</span><span class="si">}</span><span class="s">:</span><span class="si">#{</span><span class="nx">obj</span><span class="p">[</span><span class="nx">kFancy</span><span class="p">]</span><span class="si">}#{</span><span class="nx">semi</span><span class="si">}#{</span><span class="nx">newline</span><span class="si">}</span><span class="s">&quot;</span>
  <span class="nx">out</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="-attributesfromobject-convert-object-to-attribute-string">_attributesFromObject: Convert object to attribute string</h2>

<p>This object has nothing special. No renamed keys, no jquery events. It is
precicely what must be serialized with no adjustment.</p></div></div><div class="code"><div class="wrapper"><span class="nv">_attributesFromObject = </span><span class="nf">(obj) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Pass through non objects</p></div></div><div class="code"><div class="wrapper">  <span class="k">return</span> <span class="nx">obj</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isObject</span> <span class="nx">obj</span>

  <span class="nv">out = </span><span class="s">&#39;&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Serialize attributes in order for consistent output</p></div></div><div class="code"><div class="wrapper">  <span class="nv">space = </span><span class="s">&#39;&#39;</span>
  <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">obj</span><span class="p">).</span><span class="nx">sort</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Ignore null</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="nv">v = </span><span class="nx">obj</span><span class="p">[</span><span class="nx">k</span><span class="p">])</span><span class="o">?</span>
      <span class="nx">out</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">space</span><span class="si">}#{</span><span class="nx">k</span><span class="si">}</span><span class="s">=\&quot;</span><span class="si">#{</span><span class="nx">v</span><span class="si">}</span><span class="s">\&quot;&quot;</span>
    <span class="nv">space = </span><span class="s">&#39; &#39;</span>
  <span class="nx">out</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="-cssfromobject">_cssFromObject:</h2>

<p>Convert css selectors and rules to a string</p>

<pre><code>debug:true               debug:false
.cls {                   .cls{color: red}
    color: red;
}\n
</code></pre></div></div><div class="code"><div class="wrapper"><span class="nv">_cssFromObject = </span><span class="nf">(cssMap, isDebug = false) -&gt;</span>
  <span class="nv">newline = </span><span class="k">if</span> <span class="nx">isDebug</span> <span class="k">then</span> <span class="s">&#39;\n&#39;</span> <span class="k">else</span> <span class="s">&#39;&#39;</span>
  <span class="nv">space = </span><span class="k">if</span> <span class="nx">isDebug</span> <span class="k">then</span> <span class="s">&#39; &#39;</span> <span class="k">else</span> <span class="s">&#39;&#39;</span>
  <span class="nv">inline = </span><span class="o">!</span><span class="nx">isDebug</span>
  <span class="nv">indent = </span><span class="nx">isDebug</span>
  <span class="nv">css = </span><span class="s">&#39;&#39;</span>
  <span class="k">for</span> <span class="nx">selector</span><span class="p">,</span> <span class="nx">styles</span> <span class="k">of</span> <span class="nx">cssMap</span>
    <span class="nv">rules = </span><span class="nx">_styleFromObject</span> <span class="nx">styles</span><span class="p">,</span> <span class="nx">inline</span><span class="o">:</span><span class="nx">inline</span><span class="p">,</span> <span class="nx">indent</span><span class="o">:</span><span class="nx">indent</span>
    <span class="nx">css</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">selector</span><span class="si">}#{</span><span class="nx">space</span><span class="si">}</span><span class="s">{</span><span class="si">#{</span><span class="nx">newline</span><span class="si">}#{</span><span class="nx">rules</span><span class="si">}</span><span class="s">}</span><span class="si">#{</span><span class="nx">newline</span><span class="si">}</span><span class="s">&quot;</span>
  <span class="nx">css</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Recursive helper for compiling that wraps indention</p></div></div><div class="code"><div class="wrapper"><span class="nv">_compileDeeper = </span><span class="nf">(method, ojml, options) -&gt;</span>
  <span class="nv">i = </span><span class="nx">options</span><span class="p">.</span><span class="nx">indent</span>
  <span class="nx">options</span><span class="p">.</span><span class="nx">indent</span> <span class="o">+=</span> <span class="s">&#39;\t&#39;</span>
  <span class="nx">method</span> <span class="nx">ojml</span><span class="p">,</span> <span class="nx">options</span>
  <span class="nv">options.indent = </span><span class="nx">i</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Compile ojml or any type</p></div></div><div class="code"><div class="wrapper"><span class="nv">pass = </span><span class="o">-&gt;</span>
<span class="nv">_compileAny = </span><span class="nf">(ojml, options) -&gt;</span>

  <span class="k">switch</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">typeOf</span> <span class="nx">ojml</span>

    <span class="k">when</span> <span class="s">&#39;array&#39;</span>
      <span class="nx">_compileTag</span> <span class="nx">ojml</span><span class="p">,</span> <span class="nx">options</span>

    <span class="k">when</span> <span class="s">&#39;jquery&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>TODO: Missing unit tests for the jquery case</p></div></div><div class="code"><div class="wrapper">      <span class="nx">options</span><span class="p">.</span><span class="nx">html</span><span class="o">?</span><span class="p">.</span><span class="nx">push</span> <span class="nx">ojml</span><span class="p">.</span><span class="nx">html</span><span class="p">()</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">dom</span><span class="o">?</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">ojml</span><span class="p">.</span><span class="nx">get</span><span class="p">()</span>

    <span class="k">when</span> <span class="s">&#39;string&#39;</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">html</span><span class="o">?</span><span class="p">.</span><span class="nx">push</span> <span class="nx">ojml</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">dom</span><span class="o">?</span><span class="p">.</span><span class="nx">appendChild</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createTextNode</span> <span class="nx">ojml</span>

    <span class="k">when</span> <span class="s">&#39;boolean&#39;</span><span class="p">,</span> <span class="s">&#39;number&#39;</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">html</span><span class="o">?</span><span class="p">.</span><span class="nx">push</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">ojml</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">dom</span><span class="o">?</span><span class="p">.</span><span class="nx">appendChild</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createTextNode</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">ojml</span><span class="si">}</span><span class="s">&quot;</span>

    <span class="k">when</span> <span class="s">&#39;function&#39;</span>
      <span class="nx">_compileAny</span> <span class="nx">ojml</span><span class="p">(),</span> <span class="nx">options</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Do nothing for 'null', 'undefined', 'object'</p></div></div><div class="code"><div class="wrapper">    <span class="k">when</span> <span class="s">&#39;null&#39;</span> <span class="k">then</span> <span class="k">break</span>
    <span class="k">when</span> <span class="s">&#39;undefined&#39;</span> <span class="k">then</span> <span class="k">break</span>
    <span class="k">when</span> <span class="s">&#39;object&#39;</span> <span class="k">then</span> <span class="k">break</span>

    <span class="k">else</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>OJ type</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isOJ</span> <span class="nx">ojml</span>
        <span class="nx">_compileOJInstance</span> <span class="nx">ojml</span><span class="p">,</span> <span class="nx">options</span>

  <span class="k">return</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Supported events from jquery</p></div></div><div class="code"><div class="wrapper"><span class="nv">jqueryEvents = </span><span class="nx">bind</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="kc">on</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="kc">off</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">live</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">blur</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">change</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">click</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">dblclick</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">focus</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">focusin</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">focusout</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">hover</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">keydown</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">keypress</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">keyup</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">mousedown</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">mouseenter</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">mousemove</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">mouseout</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">mouseup</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">ready</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">resize</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">scroll</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">select</span><span class="o">:</span><span class="mi">1</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Compile ojml as oj object</p></div></div><div class="code"><div class="wrapper"><span class="nv">_compileOJInstance = </span><span class="nf">(ojml, options) -&gt;</span>
  <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">html</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">html</span><span class="p">.</span><span class="nx">push</span> <span class="nx">ojml</span><span class="p">.</span><span class="nx">toHTML</span> <span class="nx">options</span>
  <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">dom</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">push</span> <span class="nx">ojml</span><span class="p">.</span><span class="nx">toDOM</span> <span class="nx">options</span>
  <span class="k">return</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Compile ojml as element</p></div></div><div class="code"><div class="wrapper"><span class="nv">_compileElement = </span><span class="nf">(ojml, options) -&gt;</span>
  <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">html</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">html</span><span class="p">.</span><span class="nx">push</span> <span class="nx">ojml</span><span class="p">.</span><span class="nx">outerHTML</span><span class="p">;</span>
  <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">dom</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">push</span> <span class="nx">ojml</span>
  <span class="k">return</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Compile ojml tag (an array)</p></div></div><div class="code"><div class="wrapper"><span class="nv">_compileTag = </span><span class="nf">(ojml, options) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get tag</p></div></div><div class="code"><div class="wrapper">  <span class="nv">tag = </span><span class="nx">ojml</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>TODO: accept ojml with oj.Type instead of string for first element</p></div></div><div class="code"><div class="wrapper">  <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s">&#39;oj.compile: tag is missing in array&#39;</span><span class="p">)</span> <span class="nx">unless</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">tag</span><span class="p">)</span> <span class="o">and</span> <span class="nx">tag</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create oj object if tag is capitalized</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isCapitalLetter</span> <span class="nx">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="nx">_compileDeeper</span> <span class="nx">_compileAny</span><span class="p">,</span> <span class="p">(</span><span class="k">new</span> <span class="nx">oj</span><span class="p">[</span><span class="nx">tag</span><span class="p">]</span> <span class="nx">ojml</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="nx">options</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Record tag</p></div></div><div class="code"><div class="wrapper">  <span class="nx">options</span><span class="p">.</span><span class="nx">tags</span><span class="p">[</span><span class="nx">tag</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get attributes (optional)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">attributes = </span><span class="kc">null</span>
  <span class="k">if</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isObject</span> <span class="nx">ojml</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="nv">attributes = </span><span class="nx">ojml</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

  <span class="nv">children = </span><span class="k">if</span> <span class="nx">attributes</span> <span class="k">then</span> <span class="nx">ojml</span><span class="p">.</span><span class="nx">slice</span> <span class="mi">2</span> <span class="k">else</span> <span class="nx">ojml</span><span class="p">.</span><span class="nx">slice</span> <span class="mi">1</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Compile to css if requested</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">css</span> <span class="o">and</span> <span class="nx">tag</span> <span class="o">==</span> <span class="s">&#39;css&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Extend options.css with rules</p></div></div><div class="code"><div class="wrapper">    <span class="k">for</span> <span class="nx">selector</span><span class="p">,</span><span class="nx">styles</span> <span class="k">of</span> <span class="nx">attributes</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">css</span><span class="p">[</span><span class="nx">selector</span><span class="p">]</span> <span class="o">?=</span> <span class="nx">styles</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">options</span><span class="p">.</span><span class="nx">css</span><span class="p">[</span><span class="nx">selector</span><span class="p">],</span> <span class="nx">styles</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Compile to html if requested</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="o">not</span> <span class="nx">options</span><span class="p">.</span><span class="nx">ignore</span><span class="p">[</span><span class="nx">tag</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Alias c to class</p></div></div><div class="code"><div class="wrapper">    <span class="nx">_attributeCMeansClass</span> <span class="nx">attributes</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>style takes objects</p></div></div><div class="code"><div class="wrapper">    <span class="nx">_attributeStyleAllowsObject</span> <span class="nx">attributes</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>class takes arrays</p></div></div><div class="code"><div class="wrapper">    <span class="nx">_attributeClassAllowsArrays</span> <span class="nx">attributes</span>

    <span class="nv">events = </span><span class="nx">_attributesFilterOutEvents</span> <span class="nx">attributes</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>TODO: Consider jsoning anything that isn't a string
any keys that aren't strings are jsoned
_attributesJSONAllKeys attributes</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add dom element with attributes</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">dom</span> <span class="o">and</span> <span class="nb">document</span><span class="o">?</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create element</p></div></div><div class="code"><div class="wrapper">      <span class="nv">el = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span> <span class="nx">tag</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add self to parent</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isDOMElement</span> <span class="nx">options</span><span class="p">.</span><span class="nx">dom</span>
        <span class="nx">options</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">appendChild</span> <span class="nx">el</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Push ourselves on the dom stack (to handle children)</p></div></div><div class="code"><div class="wrapper">      <span class="nv">options.dom = </span><span class="nx">el</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Set attributes in sorted order for consistency</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isObject</span> <span class="nx">attributes</span>
        <span class="k">for</span> <span class="nx">attrName</span> <span class="k">in</span> <span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">attributes</span><span class="p">).</span><span class="nx">sort</span><span class="p">()</span>
          <span class="nv">attrValue = </span><span class="nx">attributes</span><span class="p">[</span><span class="nx">attrName</span><span class="p">]</span>
          <span class="nx">el</span><span class="p">.</span><span class="nx">setAttribute</span> <span class="nx">attrName</span><span class="p">,</span> <span class="nx">attrValue</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Bind events</p></div></div><div class="code"><div class="wrapper">      <span class="k">for</span> <span class="nx">ek</span><span class="p">,</span><span class="nx">ev</span> <span class="k">of</span> <span class="nx">events</span>
        <span class="k">if</span> <span class="nx">$</span><span class="o">?</span>
          <span class="k">if</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">ev</span>
            <span class="nx">$</span><span class="p">(</span><span class="nx">el</span><span class="p">)[</span><span class="nx">ek</span><span class="p">].</span><span class="nx">apply</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">ev</span>
          <span class="k">else</span>
            <span class="nx">$</span><span class="p">(</span><span class="nx">el</span><span class="p">)[</span><span class="nx">ek</span><span class="p">](</span><span class="nx">ev</span><span class="p">);</span>
        <span class="k">else</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">error</span> <span class="s">&quot;oj: jquery is missing when binding a &#39;</span><span class="si">#{</span><span class="nx">ek</span><span class="si">}</span><span class="s">&#39; event&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add tag with attributes</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">html</span>
      <span class="nv">attr = </span><span class="p">(</span><span class="nx">_attributesFromObject</span> <span class="nx">attributes</span><span class="p">)</span> <span class="o">?</span> <span class="s">&#39;&#39;</span>
      <span class="nv">space = </span><span class="k">if</span> <span class="nx">attr</span> <span class="o">==</span> <span class="s">&#39;&#39;</span> <span class="k">then</span> <span class="s">&#39;&#39;</span> <span class="k">else</span> <span class="s">&#39; &#39;</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">html</span><span class="p">.</span><span class="nx">push</span> <span class="s">&quot;&lt;</span><span class="si">#{</span><span class="nx">tag</span><span class="si">}#{</span><span class="nx">space</span><span class="si">}#{</span><span class="nx">attr</span><span class="si">}</span><span class="s">&gt;&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Compile your children if necessary</p></div></div><div class="code"><div class="wrapper">  <span class="k">for</span> <span class="nx">child</span> <span class="k">in</span> <span class="nx">children</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Skip intention if there is only one child</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">debug</span> <span class="o">&amp;&amp;</span> <span class="nx">children</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">html</span><span class="o">?</span><span class="p">.</span><span class="nx">push</span> <span class="s">&quot;\n\t</span><span class="si">#{</span><span class="nx">options</span><span class="p">.</span><span class="nx">indent</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="nx">_compileDeeper</span> <span class="nx">_compileAny</span><span class="p">,</span> <span class="nx">child</span><span class="p">,</span> <span class="nx">options</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Skip intention if there is only one child</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">debug</span> <span class="o">&amp;&amp;</span> <span class="nx">children</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">html</span><span class="o">?</span><span class="p">.</span><span class="nx">push</span> <span class="s">&quot;\n</span><span class="si">#{</span><span class="nx">options</span><span class="p">.</span><span class="nx">indent</span><span class="si">}</span><span class="s">&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>End html tag if you have children or your tag closes</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="o">not</span> <span class="nx">options</span><span class="p">.</span><span class="nx">ignore</span><span class="p">[</span><span class="nx">tag</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Close tag if html</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">html</span> <span class="o">and</span> <span class="p">(</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">or</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">tag</span><span class="p">.</span><span class="nx">isClosed</span><span class="p">(</span><span class="nx">tag</span><span class="p">))</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">html</span><span class="o">?</span><span class="p">.</span><span class="nx">push</span> <span class="s">&quot;&lt;/</span><span class="si">#{</span><span class="nx">tag</span><span class="si">}</span><span class="s">&gt;&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Pop ourselves if dom</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">dom</span>
      <span class="nv">options.dom = </span><span class="nx">options</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">parentNode</span>

  <span class="k">return</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Allow attributes to take style as an object</p></div></div><div class="code"><div class="wrapper"><span class="nv">_attributeStyleAllowsObject = </span><span class="nf">(attr) -&gt;</span>
  <span class="k">if</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isObject</span> <span class="nx">attr</span><span class="o">?</span><span class="p">.</span><span class="nx">style</span>
    <span class="nv">attr.style = </span><span class="nx">_styleFromObject</span> <span class="nx">attr</span><span class="p">.</span><span class="nx">style</span><span class="p">,</span> <span class="nx">inline</span><span class="o">:</span><span class="kc">true</span>
  <span class="k">return</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Allow attributes to alias c to class</p></div></div><div class="code"><div class="wrapper"><span class="nv">_attributeCMeansClass = </span><span class="nf">(attr) -&gt;</span>
  <span class="k">if</span> <span class="nx">attr</span><span class="o">?</span><span class="p">.</span><span class="nx">c</span><span class="o">?</span>
    <span class="nv">attr.class = </span><span class="nx">attr</span><span class="p">.</span><span class="nx">c</span>
    <span class="k">delete</span> <span class="nx">attr</span><span class="p">.</span><span class="nx">c</span>
  <span class="k">return</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Allow attributes to take class as an array of strings</p></div></div><div class="code"><div class="wrapper"><span class="nv">_attributeClassAllowsArrays = </span><span class="nf">(attr) -&gt;</span>
  <span class="k">if</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">attr</span><span class="o">?</span><span class="p">.</span><span class="k">class</span>
    <span class="nv">attr.class = </span><span class="nx">attr</span><span class="p">.</span><span class="nx">join</span> <span class="s">&#39; &#39;</span>
  <span class="k">return</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Filter out jquery events</p></div></div><div class="code"><div class="wrapper"><span class="nv">_attributesFilterOutEvents = </span><span class="nf">(attr) -&gt;</span>
  <span class="nv">out = </span><span class="p">{}</span>
  <span class="k">if</span> <span class="nx">attr</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Filter out attributes that are jqueryEvents</p></div></div><div class="code"><div class="wrapper">    <span class="k">for</span> <span class="nx">k</span><span class="p">,</span><span class="nx">v</span> <span class="k">of</span> <span class="nx">attr</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If this attribute (k) is an event</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">jqueryEvents</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span><span class="o">?</span>
        <span class="nx">out</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span>
        <span class="k">delete</span> <span class="nx">attr</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span>
  <span class="nx">out</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="ojtodom">oj.toDOM</h2>

<p>Make oj directly in the DOM</p></div></div><div class="code"><div class="wrapper"><span class="nv">oj.toDOM = </span><span class="nf">(options, ojml) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Options is optional</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="o">not</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isObject</span> <span class="nx">options</span>
    <span class="nv">ojml = </span><span class="nx">options</span>
    <span class="nv">options = </span><span class="p">{}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create dom not html</p></div></div><div class="code"><div class="wrapper">  <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">options</span><span class="p">,</span>
    <span class="nv">dom: </span><span class="kc">true</span>
    <span class="nv">html: </span><span class="kc">true</span>
    <span class="nv">css: </span><span class="kc">true</span>

  <span class="nv">result = </span><span class="nx">oj</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">ojml</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Bind js if it exists</p></div></div><div class="code"><div class="wrapper">  <span class="nx">result</span><span class="p">.</span><span class="nx">js</span><span class="o">?</span><span class="p">()</span>

  <span class="nx">result</span><span class="p">.</span><span class="nx">dom</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="ojtohtml">oj.toHTML</h2>

<p>Make oj directly to HTML. It will ignore all event bindings</p></div></div><div class="code"><div class="wrapper"><span class="nv">oj.toHTML = </span><span class="nf">(options, ojml) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Options is optional</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="o">not</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isObject</span> <span class="nx">options</span>
    <span class="nv">ojml = </span><span class="nx">options</span>
    <span class="nv">options = </span><span class="p">{}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create html only</p></div></div><div class="code"><div class="wrapper">  <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">options</span><span class="p">,</span>
    <span class="nv">dom: </span><span class="kc">false</span>
    <span class="nv">js: </span><span class="kc">false</span>
    <span class="nv">html: </span><span class="kc">true</span>
    <span class="nv">css: </span><span class="kc">false</span>

  <span class="p">(</span><span class="nx">oj</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">ojml</span><span class="p">).</span><span class="nx">html</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="ojtocss">oj.toCSS</h2>

<p>Make oj directly to css. It will ignore all event bindings and html</p></div></div><div class="code"><div class="wrapper"><span class="nv">oj.toCSS = </span><span class="nf">(options, ojml) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Options is optional</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="o">not</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isObject</span> <span class="nx">options</span>
    <span class="nv">ojml = </span><span class="nx">options</span>
    <span class="nv">options = </span><span class="p">{}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create html only</p></div></div><div class="code"><div class="wrapper">  <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">options</span><span class="p">,</span>
    <span class="nv">dom: </span><span class="kc">false</span>
    <span class="nv">js: </span><span class="kc">false</span>
    <span class="nv">html: </span><span class="kc">false</span>
    <span class="nv">css: </span><span class="kc">true</span>

  <span class="p">(</span><span class="nx">oj</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">ojml</span><span class="p">).</span><span class="nx">css</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="-inherit">_.inherit</h2>

<p>Based on, but sadly, incompatable with coffeescript inheritance</p></div></div><div class="code"><div class="wrapper"><span class="nv">_.inherit = </span><span class="nf">(child, parent) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Copy class properties and methods</p></div></div><div class="code"><div class="wrapper">  <span class="k">for</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">parent</span>
    <span class="nx">oj</span><span class="p">.</span><span class="nx">copyProperty</span> <span class="nx">child</span><span class="p">,</span> <span class="nx">parent</span><span class="p">,</span> <span class="nx">key</span>

  <span class="nv">ctor = </span><span class="o">-&gt;</span>
  <span class="nv">ctor:: = parent::</span>
  <span class="nv">child:: = </span><span class="k">new</span> <span class="nx">ctor</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Provide easy access for super methods
Example: @super.methodName(arguments...)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">child::super = parent::</span>

  <span class="k">return</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="ojtype">oj.type</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="nv">oj.type = </span><span class="nf">(name, args = {}) -&gt;</span>

  <span class="k">throw</span> <span class="s">&#39;oj.type: string expected for first argument&#39;</span> <span class="nx">unless</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isString</span> <span class="nx">name</span>
  <span class="k">throw</span> <span class="s">&#39;oj.type: object expected for second argument&#39;</span> <span class="nx">unless</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isObject</span> <span class="nx">args</span>

  <span class="nx">args</span><span class="p">.</span><span class="nx">methods</span> <span class="o">?=</span> <span class="p">{}</span>
  <span class="nx">args</span><span class="p">.</span><span class="nx">properties</span> <span class="o">?=</span> <span class="p">{}</span>
  <span class="nx">args</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">?=</span> <span class="o">-&gt;</span>

  <span class="nv">Out = </span><span class="k">new</span> <span class="nb">Function</span><span class="p">(</span><span class="s">&quot;&quot;&quot;return function </span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">(){</span>
<span class="s">    var _this = this;</span>
<span class="s">    if ( !(this instanceof </span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">) )</span>
<span class="s">      _this = new </span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>{name}.prototype.constructor.apply(_this, arguments);</p></div></div><div class="code"><div class="wrapper"><span class="s">    return _this;</span>
<span class="s">  }</span>
<span class="s">  &quot;&quot;&quot;</span>
  <span class="p">)();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Alias 'extends' to 'inherits' for javascript folks</p></div></div><div class="code"><div class="wrapper">  <span class="nx">args</span><span class="p">.</span><span class="k">extends</span> <span class="o">?=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">inherits</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Inherit if necessary</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="nx">args</span><span class="p">.</span><span class="k">extends</span><span class="o">?</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">inherit</span> <span class="nx">Out</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="k">extends</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add the constructor and wrap it to automatically call super.constructor</p></div></div><div class="code"><div class="wrapper">  <span class="nx">oj</span><span class="p">.</span><span class="nx">addMethod</span> <span class="nx">Out</span><span class="o">::</span><span class="p">,</span> <span class="s">&#39;constructor&#39;</span><span class="p">,</span> <span class="o">-&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Call your super's constructor</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">args</span><span class="p">.</span><span class="k">extends</span><span class="o">?</span>
      <span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="k">extends</span><span class="p">)</span><span class="o">::</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">arguments</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Then call your own constructor</p></div></div><div class="code"><div class="wrapper">    <span class="k">try</span>
      <span class="nx">args</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">arguments</span>
    <span class="k">catch</span> <span class="nx">e</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">.constructor failed with: &quot;</span><span class="p">,</span> <span class="nx">e</span>
      <span class="k">throw</span> <span class="nx">e</span>
    <span class="k">return</span> <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Mark new type and its instances with a non-enumerable _type and _oj properties</p></div></div><div class="code"><div class="wrapper">  <span class="nv">typeProps =</span>
    <span class="nv">type: </span><span class="p">{</span><span class="nx">value</span><span class="o">:</span><span class="nx">name</span><span class="p">,</span> <span class="nx">writable</span><span class="o">:</span><span class="kc">false</span><span class="p">,</span> <span class="nx">enumerable</span><span class="o">:</span><span class="kc">false</span><span class="p">}</span>
    <span class="nv">isOJ: </span><span class="p">{</span><span class="nx">value</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">writable</span><span class="o">:</span><span class="kc">false</span><span class="p">,</span> <span class="nx">enumerable</span><span class="o">:</span><span class="kc">false</span><span class="p">}</span>
  <span class="nx">oj</span><span class="p">.</span><span class="nx">addProperties</span> <span class="nx">Out</span><span class="p">,</span> <span class="nx">typeProps</span>
  <span class="nx">oj</span><span class="p">.</span><span class="nx">addProperties</span> <span class="nx">Out</span><span class="o">::</span><span class="p">,</span> <span class="nx">typeProps</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add properties helper to instance and type</p></div></div><div class="code"><div class="wrapper">  <span class="nv">propKeys = </span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">keys</span> <span class="nx">args</span><span class="p">.</span><span class="nx">properties</span><span class="p">).</span><span class="nx">sort</span><span class="p">()</span>
  <span class="k">if</span> <span class="nx">Out</span><span class="o">::</span><span class="nx">properties</span><span class="o">?</span>
    <span class="nv">propKeys = </span><span class="nx">_</span><span class="p">.</span><span class="nx">uniqueSortedUnion</span> <span class="nx">Out</span><span class="o">::</span><span class="nx">properties</span><span class="p">,</span> <span class="nx">propKeys</span>
  <span class="nv">properties = </span><span class="nx">value</span><span class="o">:</span><span class="nx">propKeys</span><span class="p">,</span> <span class="nx">writable</span><span class="o">:</span><span class="kc">false</span><span class="p">,</span> <span class="nx">enumerable</span><span class="o">:</span><span class="kc">false</span>
  <span class="nx">oj</span><span class="p">.</span><span class="nx">addProperty</span> <span class="nx">Out</span><span class="p">,</span> <span class="s">&#39;properties&#39;</span><span class="p">,</span> <span class="nx">properties</span>
  <span class="nx">oj</span><span class="p">.</span><span class="nx">addProperty</span> <span class="nx">Out</span><span class="o">::</span><span class="p">,</span> <span class="s">&#39;properties&#39;</span><span class="p">,</span> <span class="nx">properties</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add methods helper to instance and type</p></div></div><div class="code"><div class="wrapper">  <span class="nv">methodKeys = </span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">keys</span> <span class="nx">args</span><span class="p">.</span><span class="nx">methods</span><span class="p">).</span><span class="nx">sort</span><span class="p">()</span>
  <span class="k">if</span> <span class="nx">Out</span><span class="o">::</span><span class="nx">methods</span><span class="o">?</span>
    <span class="nv">methodKeys = </span><span class="nx">_</span><span class="p">.</span><span class="nx">uniqueSortedUnion</span> <span class="nx">Out</span><span class="o">::</span><span class="nx">methods</span><span class="p">,</span> <span class="nx">methodKeys</span>
  <span class="nv">methods = </span><span class="nx">value</span><span class="o">:</span><span class="nx">methodKeys</span><span class="p">,</span> <span class="nx">writable</span><span class="o">:</span><span class="kc">false</span><span class="p">,</span> <span class="nx">enumerable</span><span class="o">:</span><span class="kc">false</span>
  <span class="nx">oj</span><span class="p">.</span><span class="nx">addProperty</span> <span class="nx">Out</span><span class="p">,</span> <span class="s">&#39;methods&#39;</span><span class="p">,</span> <span class="nx">methods</span>
  <span class="nx">oj</span><span class="p">.</span><span class="nx">addProperty</span> <span class="nx">Out</span><span class="o">::</span><span class="p">,</span> <span class="s">&#39;methods&#39;</span><span class="p">,</span> <span class="nx">methods</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add methods to the type</p></div></div><div class="code"><div class="wrapper">  <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">args</span><span class="p">.</span><span class="nx">methods</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set: Set all properties on the object at once</p></div></div><div class="code"><div class="wrapper">    <span class="nv">set: </span><span class="nf">(k,v) -&gt;</span>
      <span class="nv">obj = </span><span class="nx">k</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isObject</span> <span class="nx">k</span>
        <span class="nv">obj = </span><span class="p">{}</span>
        <span class="nx">obj</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span><span class="p">;</span>
      <span class="k">for</span> <span class="nx">key</span><span class="p">,</span><span class="nx">value</span> <span class="k">of</span> <span class="nx">obj</span>
        <span class="nx">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>
      <span class="k">return</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>toJSON: Use properties to generate json</p></div></div><div class="code"><div class="wrapper">    <span class="nv">toJSON: </span><span class="o">-&gt;</span>
      <span class="nv">json = </span><span class="p">{}</span>
      <span class="k">for</span> <span class="nx">prop</span> <span class="k">in</span> <span class="nx">@properties</span>
        <span class="nx">json</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span>
      <span class="nx">json</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add methods</p></div></div><div class="code"><div class="wrapper">  <span class="nx">oj</span><span class="p">.</span><span class="nx">addMethods</span> <span class="nx">Out</span><span class="o">::</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">methods</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add the properties</p></div></div><div class="code"><div class="wrapper">  <span class="nx">oj</span><span class="p">.</span><span class="nx">addProperties</span> <span class="nx">Out</span><span class="o">::</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">properties</span>

  <span class="nx">Out</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="ojview">oj.view</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="nv">oj.view = </span><span class="nf">(name, args) -&gt;</span>
  <span class="k">throw</span> <span class="s">&#39;oj.view: string expected for first argument&#39;</span> <span class="nx">unless</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isString</span> <span class="nx">name</span>
  <span class="k">throw</span> <span class="s">&#39;oj.view: object expected for second argument&#39;</span> <span class="nx">unless</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isObject</span> <span class="nx">args</span>
  <span class="nx">args</span><span class="p">.</span><span class="k">extends</span> <span class="o">?=</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">View</span>
  <span class="nx">oj</span><span class="p">.</span><span class="nx">type</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">args</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>optionsUnion:
Take arguments and tranform them into options and args.
options is a union of all items in <code>arguments</code> that are objects
args is a concat of all arguments that aren't objects in the same order</p></div></div><div class="code"><div class="wrapper"><span class="nv">_.optionsUnion = </span><span class="nf">(argList) -&gt;</span>
  <span class="nv">obj = </span><span class="p">{}</span>
  <span class="nv">list = </span><span class="p">[]</span>
  <span class="k">for</span> <span class="nx">v</span> <span class="k">in</span> <span class="nx">argList</span>
    <span class="k">if</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isObject</span> <span class="nx">v</span>
      <span class="nv">obj = </span><span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">v</span>
    <span class="k">else</span>
      <span class="nx">list</span><span class="p">.</span><span class="nx">push</span> <span class="nx">v</span>
  <span class="nv">options: </span><span class="nx">obj</span><span class="p">,</span> <span class="nv">args: </span><span class="nx">list</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="ojview">oj.View</h2>

<p>Properties
  $el           Reference el
  attributes    Initialize from element, $(selector), or ojml</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Methods
  css</p></div></div><div class="code"><div class="wrapper"><span class="nv">oj.View = </span><span class="nx">oj</span><span class="p">.</span><span class="nx">type</span> <span class="s">&#39;View&#39;</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Views are special objects map properties together. This is a union of arguments
With the remaining arguments becoming a list</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="">#</h1></div></div></div><div class="segment"><div class="code"><div class="wrapper">    <span class="nx">CheckBox</span> <span class="o">is</span> <span class="nx">constructed</span>
      <span class="o">=&gt;</span> <span class="nx">Its</span> <span class="nx">properties</span> <span class="nx">are</span> <span class="nx">set</span> <span class="p">(</span><span class="o">and</span> <span class="k">this</span> <span class="nx">makes</span> <span class="nx">the</span> <span class="nx">el</span><span class="p">)</span>
      <span class="o">=&gt;</span> <span class="nx">value</span> <span class="o">is</span> <span class="nx">storied</span> <span class="k">in</span> <span class="nx">the</span> <span class="nx">dom</span> <span class="nx">element</span>

      <span class="nx">When</span> <span class="nx">it</span> <span class="o">is</span> <span class="nx">pushed</span> <span class="nx">into</span> <span class="nx">the</span> <span class="nx">dom</span>
        <span class="o">=&gt;</span> <span class="nx">Its</span> <span class="nx">dom</span><span class="p">.</span><span class="nx">outerHTML</span> <span class="o">is</span> <span class="nx">called</span><span class="o">?</span>

      <span class="nx">Later</span> <span class="k">when</span> <span class="nx">you</span> <span class="nx">manipulate</span> <span class="nx">it</span> <span class="kc">on</span> <span class="nx">the</span> <span class="nx">client</span>
      <span class="nx">makeOrGet</span> <span class="nx">awakens</span> <span class="nx">it</span> <span class="k">in</span> <span class="nx">place</span> <span class="k">in</span> <span class="nx">the</span> <span class="nx">dom</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="">#</h1></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="nv">constructor: </span><span class="o">-&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Simplify arguments to a single object of properties and a single list of arguments</p></div></div><div class="code"><div class="wrapper">    <span class="p">{</span><span class="nx">options</span><span class="p">,</span> <span class="nx">args</span><span class="p">}</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">optionsUnion</span> <span class="nx">arguments</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Generate id if missing</p></div></div><div class="code"><div class="wrapper">    <span class="nx">options</span><span class="p">.</span><span class="nx">id</span> <span class="o">?=</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">id</span><span class="p">()</span>
    <span class="vi">@_id = </span><span class="nx">options</span><span class="p">.</span><span class="nx">id</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Views act like tag methods and support the div -> syntax.
Append this to parent</p></div></div><div class="code"><div class="wrapper">    <span class="nx">_</span><span class="p">.</span><span class="nx">argumentsAppend</span> <span class="nx">@</span>

    <span class="nx">@set</span> <span class="nx">options</span>
    <span class="k">return</span>

  <span class="nv">properties:</span>
    <span class="nv">el:</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Getting an element is the key to OJ. It takes a few steps:</p></div></div><div class="code"><div class="wrapper">      <span class="nv">get: </span><span class="o">-&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Step one: use the cached version if possible</p></div></div><div class="code"><div class="wrapper">        <span class="k">return</span> <span class="nx">@_el</span> <span class="k">if</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isDOMElement</span> <span class="nx">@_el</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Step two: search for the element in the dom
This will "awaken" this object to allow live editing</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="nb">document</span><span class="o">?</span>
          <span class="vi">@_el = </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementsById</span> <span class="nx">@_id</span>
          <span class="k">return</span> <span class="nx">@_el</span> <span class="k">if</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">isDOMElement</span> <span class="nx">@_el</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Step three: create it ourselves</p></div></div><div class="code"><div class="wrapper">        <span class="nv">ojml = </span><span class="nx">@make</span><span class="p">()</span>
        <span class="nv">results = </span><span class="nx">oj</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">dom</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">ojml</span><span class="p">)</span>
        <span class="nx">results</span><span class="p">.</span><span class="nx">js</span><span class="p">()</span>
        <span class="nx">results</span><span class="p">.</span><span class="nx">dom</span>

    <span class="nv">$el:</span>
      <span class="nv">get: </span><span class="o">-&gt;</span> <span class="nx">$</span><span class="p">(</span><span class="nx">@el</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Read only generated oj-guid</p></div></div><div class="code"><div class="wrapper">    <span class="nv">id: get: </span><span class="o">-&gt;</span> <span class="nx">@_id</span>

    <span class="nv">attributes:</span>
      <span class="nv">get: </span><span class="o">-&gt;</span> <span class="nx">@$el</span><span class="p">.</span><span class="nx">attributes</span><span class="p">()</span>
      <span class="nv">set: </span><span class="o">-&gt;</span> <span class="nx">@$el</span><span class="p">.</span><span class="nx">attributes</span> <span class="nx">arguments</span><span class="p">...</span>

    <span class="nv">hidden:</span>
      <span class="nv">get: </span><span class="o">-&gt;</span> <span class="nx">$el</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s">&#39;display&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;none&#39;</span>
      <span class="nv">set: </span><span class="nf">(v) -&gt;</span> <span class="k">if</span> <span class="nx">v</span> <span class="k">then</span> <span class="nx">$el</span><span class="p">.</span><span class="nx">hide</span><span class="p">()</span> <span class="k">else</span> <span class="nx">$el</span><span class="p">.</span><span class="nx">show</span><span class="p">()</span>

  <span class="nv">methods:</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>make: Return ojml that creates initial dom state
Override this to create your own structure</p></div></div><div class="code"><div class="wrapper">    <span class="nv">make: </span><span class="o">-&gt;</span>
      <span class="nv">ojml = </span><span class="nx">oj</span><span class="p">.</span><span class="nx">div</span> <span class="nx">c</span><span class="o">:</span><span class="s">&quot;oj.</span><span class="si">#{</span><span class="nx">oj</span><span class="p">.</span><span class="nx">typeOf</span> <span class="nx">@</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span><span class="nx">oj</span><span class="p">.</span><span class="nx">id</span><span class="p">()</span>
      <span class="nx">oj</span><span class="p">.</span><span class="nx">toDOM</span> <span class="nx">ojml</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Find sub elements via jquery selector</p></div></div><div class="code"><div class="wrapper">    <span class="nv">$: </span><span class="o">-&gt;</span> <span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span> <span class="nx">arguments</span><span class="p">...</span>

    <span class="nv">toHTML: </span><span class="nf">(options) -&gt;</span> <span class="nx">@el</span><span class="p">.</span><span class="nx">outerHTML</span> <span class="o">+</span> <span class="p">(</span><span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">debug</span> <span class="k">then</span> <span class="s">&#39;\n&#39;</span> <span class="k">else</span> <span class="s">&#39;&#39;</span><span class="p">)</span>

    <span class="nv">toDOM: </span><span class="o">-&gt;</span> <span class="nx">@el</span>

    <span class="nv">toString: </span><span class="o">-&gt;</span> <span class="nx">@toHTML</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Detach element from dom</p></div></div><div class="code"><div class="wrapper">    <span class="nv">detach: </span><span class="o">-&gt;</span> <span class="k">throw</span> <span class="s">&#39;detach nyi&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The implementation is to set el manipulate it, and remember how to set it back</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Attach element to dom where it use to be</p></div></div><div class="code"><div class="wrapper">    <span class="nv">attach: </span><span class="o">-&gt;</span> <span class="k">throw</span> <span class="s">&#39;attach nyi&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The implementation is to unset el from detach</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="ojcheckbox">oj.CheckBox</h2>

<p>CheckBox control</p></div></div><div class="code"><div class="wrapper"><span class="nv">oj.CheckBox = </span><span class="nx">oj</span><span class="p">.</span><span class="nx">type</span> <span class="s">&#39;CheckBox&#39;</span>
  <span class="k">extends</span><span class="o">:</span> <span class="nx">oj</span><span class="p">.</span><span class="nx">View</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>constructor: ->
  @set arguments...</p></div></div><div class="code"><div class="wrapper">  <span class="nv">properties:</span>

    <span class="nv">value:</span>
      <span class="nv">get: </span><span class="o">-&gt;</span> <span class="nx">@_value</span>
      <span class="nv">set: </span><span class="nf">(v) -&gt;</span> <span class="vi">@_value = </span><span class="nx">v</span><span class="p">;</span> <span class="k">return</span>

    <span class="nv">disabled:</span>
      <span class="nv">get: </span><span class="o">-&gt;</span> <span class="nx">@el</span><span class="p">.</span><span class="nx">disabled</span>
      <span class="nv">set: </span><span class="nf">(v) -&gt;</span> <span class="vi">@el.disabled = </span><span class="nx">v</span><span class="p">;</span> <span class="k">return</span>

  <span class="nv">methods:</span>
    <span class="nv">make: </span><span class="nf">(props) -&gt;</span>
      <span class="nx">oj</span><span class="p">.</span><span class="nx">input</span> <span class="nv">id: </span><span class="nx">oj</span><span class="p">.</span><span class="nx">id</span><span class="p">(),</span> <span class="nx">c</span><span class="o">:</span><span class="nx">@type</span><span class="p">,</span> <span class="nx">type</span><span class="o">:</span><span class="s">&#39;checkbox&#39;</span>

    <span class="nv">toString: </span><span class="o">-&gt;</span>
      <span class="nx">@</span><span class="k">super</span><span class="p">.</span><span class="nx">toString</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">@</span><span class="p">,</span><span class="nx">arguments</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="ojlist">oj.List</h2>

<p>List control</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>oj.List = oj.type 'List',
  constructor: -></p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>methods:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="ojlink">oj.Link</h2>

<p>oj.Link = class Link extends Control</p></div></div></div></div></body></html>