<!DOCTYPE html><html lang="en"><head><title>command</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="command"><meta name="groc-project-path" content="src/command.coffee"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/command.coffee</div></div><div id="document"><div class="segment"></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="commandcoffee">command.coffee</h1></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="nv">vm = </span><span class="nx">require</span> <span class="s">&#39;vm&#39;</span>
<span class="nv">commander = </span><span class="nx">require</span> <span class="s">&#39;commander&#39;</span>
<span class="nv">fs = </span><span class="nx">require</span> <span class="s">&#39;fs&#39;</span>
<span class="nv">coffee = </span><span class="nx">require</span> <span class="s">&#39;coffee-script&#39;</span>
<span class="nv">oj = </span><span class="nx">require</span> <span class="s">&#39;./oj&#39;</span>
<span class="nv">uglifyjs = </span><span class="nx">require</span> <span class="s">&#39;uglify-js&#39;</span>
<span class="nv">csso = </span><span class="nx">require</span> <span class="s">&#39;csso&#39;</span>
<span class="nv">path = </span><span class="nx">require</span> <span class="s">&#39;path&#39;</span>
<span class="nv">_ = </span><span class="nx">require</span> <span class="s">&#39;underscore&#39;</span>

<span class="nv">module.exports = </span><span class="o">-&gt;</span>

  <span class="nx">commander</span><span class="p">.</span><span class="nx">version</span><span class="p">(</span><span class="s">&#39;0.0.5&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">usage</span><span class="p">(</span><span class="s">&#39;[options] &lt;file, ...&gt;&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">option</span><span class="p">(</span><span class="s">&#39;-d, --debug&#39;</span><span class="p">,</span> <span class="s">&#39;Turn on debug output (default: false)&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">option</span><span class="p">(</span><span class="s">&#39;-o, --output &lt;dir&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;Directory to output all files to (default: .)&#39;</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">())</span>
    <span class="p">.</span><span class="nx">option</span><span class="p">(</span><span class="s">&#39;-r, --recurse&#39;</span><span class="p">,</span> <span class="s">&#39;Recurse into directories (default: off)&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">option</span><span class="p">(</span><span class="s">&#39;-v, --verbose &lt;level&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;Turn on verbose level 0-3 (default: 1)&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">option</span><span class="p">(</span><span class="s">&#39;-m, --modules &lt;modules&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;List of modules to include&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>.option('-w, --watch <dir,dir,...>', 'Directories to watch (default: off)', trimArgList)</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Verify output is a directory</p></div></div><div class="code"><div class="wrapper">  <span class="nx">error</span> <span class="s">&quot;`</span><span class="si">#{</span><span class="nx">commander</span><span class="p">.</span><span class="nx">output</span><span class="si">}</span><span class="s">` is not a directory&quot;</span> <span class="nx">unless</span> <span class="nx">isDirectory</span> <span class="nx">commander</span><span class="p">.</span><span class="nx">output</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Convert args to full paths</p></div></div><div class="code"><div class="wrapper">  <span class="nv">commander.args = </span><span class="nx">fullPaths</span> <span class="nx">commander</span><span class="p">.</span><span class="nx">args</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Show usage with no parameters</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">commander</span><span class="p">.</span><span class="nx">args</span><span class="p">)</span> <span class="o">or</span> <span class="nx">commander</span><span class="p">.</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="nx">usage</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Handle recursion and gather files to compile</p></div></div><div class="code"><div class="wrapper">  <span class="nx">recurseIf</span> <span class="nx">commander</span><span class="p">.</span><span class="nx">recurse</span><span class="p">,</span> <span class="nx">commander</span><span class="p">.</span><span class="nx">args</span><span class="p">,</span> <span class="nf">(err, files) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Verify args are actually files</p></div></div><div class="code"><div class="wrapper">    <span class="k">for</span> <span class="nx">f</span> <span class="k">in</span> <span class="nx">files</span>
      <span class="nx">error</span> <span class="s">&quot;`</span><span class="si">#{</span><span class="nx">f</span><span class="si">}</span><span class="s">` is not a file&quot;</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">isFile</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>All verbose</p></div></div><div class="code"><div class="wrapper">    <span class="nv">commander.verbose = </span><span class="mi">3</span> <span class="k">if</span> <span class="nx">commander</span><span class="p">.</span><span class="nx">verbose</span> <span class="o">==</span> <span class="s">&#39;all&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Clear underscore as modules might need it</p></div></div><div class="code"><div class="wrapper">    <span class="nx">_clearRequireCacheRecord</span> <span class="s">&#39;underscore&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Compile all files</p></div></div><div class="code"><div class="wrapper">    <span class="nv">compileOptions =</span>
      <span class="nv">outputDir: </span><span class="nx">commander</span><span class="p">.</span><span class="nx">output</span>
      <span class="nv">modules: </span><span class="nx">commander</span><span class="p">.</span><span class="nx">modules</span> <span class="o">or</span> <span class="p">[]</span>
      <span class="nv">debug: </span><span class="nx">commander</span><span class="p">.</span><span class="nx">debug</span> <span class="o">or</span> <span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>OJ needs path to implement require</p></div></div><div class="code"><div class="wrapper">    <span class="nx">compileOptions</span><span class="p">.</span><span class="nx">modules</span><span class="p">.</span><span class="nx">push</span> <span class="s">&#39;oj&#39;</span>
    <span class="nx">compileOptions</span><span class="p">.</span><span class="nx">modules</span><span class="p">.</span><span class="nx">push</span> <span class="s">&#39;path&#39;</span>

    <span class="k">for</span> <span class="nx">file</span> <span class="k">in</span> <span class="nx">files</span>
      <span class="nx">compile</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">compileOptions</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="commands">Commands</h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="recurseif">recurseIf</h2>

<p>Abstracts if recursion happened and returns files either recursed or not
depending on condition</p></div></div><div class="code"><div class="wrapper"><span class="nv">recurseIf = </span><span class="nf">(condition, paths, cb) -&gt;</span>
  <span class="k">if</span> <span class="nx">condition</span>
    <span class="nx">ls</span> <span class="nx">paths</span><span class="p">,</span> <span class="nf">(err, results) -&gt;</span>
      <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">results</span><span class="p">.</span><span class="nx">files</span>
  <span class="k">else</span>
    <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">paths</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="compile">compile</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="nv">compile = </span><span class="nf">(filePath, options = {}) -&gt;</span>
  <span class="nv">outputDir = </span><span class="nx">options</span><span class="p">.</span><span class="nx">outputDir</span> <span class="o">||</span> <span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">()</span>
  <span class="nv">fileOut = </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span> <span class="nx">outputDir</span><span class="p">,</span> <span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">basename</span> <span class="nx">filePath</span><span class="p">,</span> <span class="s">&#39;.oj&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;.html&#39;</span>
  <span class="nx">verbose</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;compiling </span><span class="si">#{</span><span class="nx">filePath</span><span class="si">}</span><span class="s">&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Cache of modules, files, and native modules</p></div></div><div class="code"><div class="wrapper">  <span class="nv">cache = </span><span class="nx">modules</span><span class="o">:</span><span class="p">{},</span> <span class="nx">files</span><span class="o">:</span><span class="p">{},</span> <span class="nx">native</span><span class="o">:</span><span class="p">{}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Module store for require hook</p></div></div><div class="code"><div class="wrapper">  <span class="nv">modules = </span><span class="p">{}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Hook require to intercept requires in oj files</p></div></div><div class="code"><div class="wrapper">  <span class="nx">_hookRequire</span> <span class="nx">modules</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Save require cache</p></div></div><div class="code"><div class="wrapper">  <span class="nx">_saveRequireCache</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add user defined modules</p></div></div><div class="code"><div class="wrapper">  <span class="k">for</span> <span class="nx">m</span> <span class="k">in</span> <span class="nx">options</span><span class="p">.</span><span class="nx">modules</span>
    <span class="k">if</span> <span class="nx">isNodeModule</span> <span class="nx">m</span>
      <span class="nx">_buildNativeCacheFromModuleList</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">native</span><span class="p">,</span> <span class="p">[</span><span class="nx">m</span><span class="p">],</span> <span class="nx">options</span><span class="p">.</span><span class="nx">debug</span>
      <span class="nx">verbose</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;found </span><span class="si">#{</span><span class="nx">m</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="k">else</span>
      <span class="nx">require</span> <span class="nx">m</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Require this file to start the process</p></div></div><div class="code"><div class="wrapper">  <span class="nv">ojml = </span><span class="nx">require</span> <span class="nx">filePath</span>
  <span class="nv">html = </span><span class="p">(</span><span class="nx">oj</span><span class="p">.</span><span class="nx">compile</span> <span class="nv">debug: </span><span class="nx">options</span><span class="p">.</span><span class="nx">debug</span><span class="p">,</span> <span class="nx">ojml</span><span class="p">).</span><span class="nx">html</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Restore require cache</p></div></div><div class="code"><div class="wrapper">  <span class="nx">_restoreRequireCache</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Error if compiled file is missing required tags</p></div></div><div class="code"><div class="wrapper">  <span class="nx">error</span> <span class="s">&quot;&lt;html&gt; tag is missing (</span><span class="si">#{</span><span class="nx">filePath</span><span class="si">}</span><span class="s">)&quot;</span> <span class="k">if</span> <span class="nx">html</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s">&#39;&lt;html&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
  <span class="nx">error</span> <span class="s">&quot;&lt;body&gt; tag is missing (</span><span class="si">#{</span><span class="nx">filePath</span><span class="si">}</span><span class="s">)&quot;</span> <span class="k">if</span> <span class="nx">html</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s">&#39;&lt;body&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Build cache</p></div></div><div class="code"><div class="wrapper">  <span class="nx">verbose</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;caching </span><span class="si">#{</span><span class="nx">filePath</span><span class="si">}</span><span class="s"> (</span><span class="si">#{</span><span class="nx">_length</span> <span class="nx">modules</span><span class="si">}</span><span class="s"> files)&quot;</span>
  <span class="nv">cache = </span><span class="nx">_buildRequireCache</span> <span class="nx">modules</span><span class="p">,</span> <span class="nx">cache</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Serialize cache</p></div></div><div class="code"><div class="wrapper">  <span class="nv">cacheLength = </span><span class="nx">_length</span><span class="p">(</span><span class="nx">cache</span><span class="p">.</span><span class="nx">files</span><span class="p">)</span> <span class="o">+</span> <span class="nx">_length</span><span class="p">(</span><span class="nx">cache</span><span class="p">.</span><span class="nx">modules</span><span class="p">)</span> <span class="o">+</span> <span class="nx">_length</span><span class="p">(</span><span class="nx">cache</span><span class="p">.</span><span class="nx">native</span><span class="p">)</span>
  <span class="nx">verbose</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;serializing </span><span class="si">#{</span><span class="nx">filePath</span><span class="si">}</span><span class="s"> (</span><span class="si">#{</span><span class="nx">cacheLength</span><span class="si">}</span><span class="s"> files)&quot;</span>
  <span class="nv">scriptHtml = </span><span class="nx">_requireCacheToString</span> <span class="nx">cache</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">debug</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Insert script into html just before </body></p></div></div><div class="code"><div class="wrapper">  <span class="nv">html = </span><span class="nx">_insertAt</span> <span class="nx">html</span><span class="p">,</span> <span class="p">(</span><span class="nx">html</span><span class="p">.</span><span class="nx">lastIndexOf</span> <span class="s">&#39;&lt;/body&gt;&#39;</span><span class="p">),</span> <span class="nx">scriptHtml</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Write file</p></div></div><div class="code"><div class="wrapper">  <span class="nx">verbose</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;compiled </span><span class="si">#{</span><span class="nx">fileOut</span><span class="si">}</span><span class="s">&quot;</span>
  <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileSync</span> <span class="nx">fileOut</span><span class="p">,</span> <span class="nx">html</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="watch">watch</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="nv">watch = </span><span class="nf">(dir, options = {}) -&gt;</span>
  <span class="nx">verbose</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;watching </span><span class="si">#{</span><span class="nx">dir</span><span class="si">}</span><span class="s">&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="helpers">Helpers</h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="output-helpers">Output helpers</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="nv">error = </span><span class="nf">(message, exitCode = 1) -&gt;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;\n  error:&#39;</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="s">&quot;\n&quot;</span>
  <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span> <span class="nx">exitCode</span>

<span class="nv">success = </span><span class="o">-&gt;</span>
  <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span> <span class="mi">0</span>

<span class="nv">usage = </span><span class="nf">(code = 0) -&gt;</span>
  <span class="nx">commander</span><span class="p">.</span><span class="nx">help</span><span class="p">()</span>
  <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span> <span class="nx">code</span>

<span class="nv">tabs = </span><span class="nf">(count) -&gt;</span>
  <span class="nb">Array</span><span class="p">(</span><span class="nx">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s">&#39;\t&#39;</span><span class="p">)</span>

<span class="nv">spaces = </span><span class="nf">(count) -&gt;</span>
  <span class="nb">Array</span><span class="p">(</span><span class="nx">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Print if verbose is set</p></div></div><div class="code"><div class="wrapper"><span class="nv">verbose = </span><span class="nf">(level, message) -&gt;</span>
  <span class="k">if</span> <span class="nx">commander</span><span class="p">.</span><span class="nx">verbose</span> <span class="o">&gt;=</span> <span class="nx">level</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">spaces</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="nx">level</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="si">}#{</span><span class="nx">message</span><span class="si">}</span><span class="s">&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="file-helpers">File helpers</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="nv">isFile = </span><span class="nf">(filePath) -&gt;</span>
  <span class="k">try</span>
    <span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">statSync</span> <span class="nx">filePath</span><span class="p">).</span><span class="nx">isFile</span><span class="p">()</span>
  <span class="k">catch</span> <span class="nx">e</span>
    <span class="kc">false</span>

<span class="nv">isDirectory = </span><span class="nf">(dirpath) -&gt;</span>
  <span class="k">try</span>
    <span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">statSync</span> <span class="nx">dirpath</span><span class="p">).</span><span class="nx">isDirectory</span><span class="p">()</span>
  <span class="k">catch</span> <span class="nx">e</span>
    <span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>relativePathWithEscaping
Example: '/User/name/folder1/file.oj' => '/file.oj'</p></div></div><div class="code"><div class="wrapper"><span class="nv">relativePathWithEscaping = </span><span class="nf">(fullPath, relativeTo) -&gt;</span>
  <span class="nx">_escapeSingleQuotes</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">path</span><span class="p">.</span><span class="nx">relative</span> <span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">(),</span> <span class="nx">fullPath</span>

<span class="nv">fullPaths = </span><span class="nf">(relativePaths, dir) -&gt;</span>
  <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">map</span> <span class="nx">relativePaths</span><span class="p">,</span> <span class="nf">(p) -&gt;</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span> <span class="nx">dir</span><span class="p">,</span> <span class="nx">p</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>From a list of paths, find all directories and files</p></div></div><div class="code"><div class="wrapper"><span class="nv">ls = </span><span class="nf">(paths, cb, results = {files:[], directories:[]}) -&gt;</span>
  <span class="nv">pending = </span><span class="nx">paths</span><span class="p">.</span><span class="nx">length</span>
  <span class="nv">breakIfDone = </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">pending</span> <span class="o">==</span> <span class="mi">0</span>
      <span class="nv">results.files = </span><span class="nx">_</span><span class="p">.</span><span class="nx">uniq</span> <span class="nx">results</span><span class="p">.</span><span class="nx">files</span>
      <span class="nv">results.directories = </span><span class="nx">_</span><span class="p">.</span><span class="nx">uniq</span> <span class="nx">results</span><span class="p">.</span><span class="nx">directories</span>
      <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">results</span>

  <span class="k">for</span> <span class="nx">fullpath</span> <span class="k">in</span> <span class="nx">paths</span>
    <span class="nx">do</span><span class="nf">(fullpath) -&gt;</span>
      <span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span> <span class="nx">fullpath</span><span class="p">,</span> <span class="nf">(err, stat) -&gt;</span>
        <span class="k">if</span> <span class="nx">stat</span><span class="o">?</span><span class="p">.</span><span class="nx">isDirectory</span><span class="p">()</span>
          <span class="nx">fs</span><span class="p">.</span><span class="nx">readdir</span> <span class="nx">fullpath</span><span class="p">,</span> <span class="nf">(err_, paths_) -&gt;</span>
            <span class="k">return</span> <span class="nx">cb</span> <span class="nx">err_</span> <span class="k">if</span> <span class="nx">err_</span>
            <span class="nx">results</span><span class="p">.</span><span class="nx">directories</span><span class="p">.</span><span class="nx">push</span> <span class="nx">fullpath</span>
            <span class="nv">paths_ = </span><span class="nx">fullPaths</span> <span class="nx">paths_</span><span class="p">,</span> <span class="nx">fullpath</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Recurse on children paths</p></div></div><div class="code"><div class="wrapper">            <span class="nx">ls</span> <span class="nx">paths_</span><span class="p">,</span> <span class="p">(</span><span class="nf">(err3, res) -&gt;</span> <span class="nx">breakIfDone</span> <span class="o">--</span><span class="nx">pending</span><span class="p">),</span> <span class="nx">results</span>
        <span class="k">else</span>
          <span class="nx">results</span><span class="p">.</span><span class="nx">files</span><span class="p">.</span><span class="nx">push</span> <span class="nx">fullpath</span>
          <span class="nx">breakIfDone</span> <span class="o">--</span><span class="nx">pending</span>
  <span class="nx">breakIfDone</span><span class="p">()</span>

<span class="nv">readFileSync = </span><span class="nf">(filePath) -&gt;</span>
  <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span> <span class="nx">filePath</span><span class="p">,</span> <span class="s">&#39;utf8&#39;</span>

<span class="nv">_commonPath = </span><span class="nf">(moduleName, moduleParentPaths) -&gt;</span>
  <span class="k">return</span> <span class="kc">null</span> <span class="nx">unless</span> <span class="nx">moduleName</span><span class="o">?</span> <span class="o">and</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">moduleParentPaths</span>
  <span class="k">for</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">moduleParentPaths</span>
    <span class="k">if</span> <span class="nx">_startsWith</span> <span class="nx">moduleName</span><span class="p">,</span> <span class="nx">p</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span>
      <span class="k">return</span> <span class="nx">p</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span>
  <span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="string-helpers">String helpers</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="nv">trimArgList = </span><span class="nf">(v) -&gt;</span>
  <span class="nx">_trim</span> <span class="nx">v</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>trim</p></div></div><div class="code"><div class="wrapper"><span class="nv">_trim = </span><span class="nf">(any) -&gt;</span>
  <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span> <span class="nx">any</span>
    <span class="nx">any</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span>
  <span class="k">else</span> <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">any</span>
    <span class="nv">out = </span><span class="nx">_</span><span class="p">.</span><span class="nx">map</span> <span class="nx">any</span><span class="p">,</span> <span class="nf">(v) -&gt;</span> <span class="nx">v</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">reject</span> <span class="nx">out</span><span class="p">,</span> <span class="p">(</span><span class="nf">(v) -&gt;</span> <span class="nx">v</span> <span class="o">==</span> <span class="s">&#39;&#39;</span> <span class="o">or</span> <span class="nx">v</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
  <span class="k">else</span>
    <span class="nx">any</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>startsWith</p></div></div><div class="code"><div class="wrapper"><span class="nv">_startsWith = </span><span class="nf">(strInput, strStart) -&gt;</span>
  <span class="k">throw</span> <span class="s">&#39;startsWith: argument error&#39;</span> <span class="nx">unless</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isString</span> <span class="nx">strInput</span><span class="p">)</span> <span class="o">and</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isString</span> <span class="nx">strStart</span><span class="p">)</span>
  <span class="nx">strInput</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="nx">strStart</span><span class="p">.</span><span class="nx">length</span> <span class="o">and</span> <span class="nx">strInput</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="nx">strStart</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

<span class="nv">_escapeSingleQuotes = </span><span class="nf">(str) -&gt;</span>
  <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/&#39;/g</span><span class="p">,</span> <span class="s">&quot;\\&#39;&quot;</span>

<span class="nv">_insertAt = </span><span class="nf">(str, ix, substr) -&gt;</span>
  <span class="nx">str</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">ix</span><span class="p">)</span> <span class="o">+</span> <span class="nx">substr</span> <span class="o">+</span> <span class="nx">str</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">ix</span><span class="p">)</span>

<span class="nv">_length = </span><span class="nf">(any) -&gt;</span>
  <span class="nx">any</span><span class="p">.</span><span class="nx">length</span> <span class="o">or</span> <span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">any</span><span class="p">).</span><span class="nx">length</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="code-minification">Code minification</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="nv">minifyJS = </span><span class="nf">(filename, js, options = {}) -&gt;</span>
  <span class="nx">verbose</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;minified </span><span class="si">#{</span><span class="nx">filename</span><span class="si">}</span><span class="s">&quot;</span> <span class="k">if</span> <span class="nx">filename</span>
  <span class="k">try</span>
    <span class="nv">js = </span><span class="nx">uglifyjs</span> <span class="nx">js</span><span class="p">,</span> <span class="nx">options</span>
  <span class="k">catch</span> <span class="nx">e</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;oj.command: could not minify: </span><span class="si">#{</span><span class="nx">filename</span><span class="si">}</span><span class="s">&quot;</span> <span class="k">if</span> <span class="nx">filename</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">e</span>
    <span class="k">throw</span> <span class="nx">e</span>

<span class="nv">minifyJSUnless = </span><span class="nf">(isDebug, filename, js, options) -&gt;</span>
  <span class="k">return</span> <span class="nx">js</span> <span class="k">if</span> <span class="nx">isDebug</span>
  <span class="k">return</span> <span class="nx">minifyJS</span> <span class="nx">filename</span><span class="p">,</span> <span class="nx">js</span><span class="p">,</span> <span class="nx">options</span>

<span class="nv">minifySimpleJS = </span><span class="nf">(js, options = {}) -&gt;</span>
  <span class="nv">js = </span><span class="nx">js</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/\n/g</span><span class="p">,</span> <span class="s">&#39;&#39;</span>
  <span class="nx">js</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/\s\s+/g</span><span class="p">,</span> <span class="s">&#39; &#39;</span>

<span class="nv">minifySimpleJSUnless = </span><span class="nf">(isDebug, js, options) -&gt;</span>
  <span class="k">return</span> <span class="nx">js</span> <span class="k">if</span> <span class="nx">isDebug</span>
  <span class="k">return</span> <span class="nx">minifySimpleJS</span> <span class="nx">js</span><span class="p">,</span> <span class="nx">options</span>

<span class="nv">minifyCSS = </span><span class="nf">(filename, css, structureOff = false) -&gt;</span>
  <span class="nx">verbose</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;minified </span><span class="si">#{</span><span class="nx">filename</span><span class="si">}</span><span class="s">&quot;</span> <span class="k">if</span> <span class="nx">filename</span>
  <span class="k">try</span>
    <span class="nv">css = </span><span class="nx">csso</span><span class="p">.</span><span class="nx">justDoIt</span> <span class="nx">css</span><span class="p">,</span> <span class="nx">structureOff</span>
  <span class="k">catch</span> <span class="nx">e</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;oj.command: could not minify: </span><span class="si">#{</span><span class="nx">filename</span><span class="si">}</span><span class="s">&quot;</span> <span class="k">if</span> <span class="nx">filename</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">e</span>
    <span class="k">throw</span> <span class="nx">e</span>

<span class="nv">minifyCSSUnless = </span><span class="nf">(isDebug, filename, css, structureOff) -&gt;</span>
  <span class="k">return</span> <span class="nx">css</span> <span class="k">if</span> <span class="nx">isDebug</span>
  <span class="k">return</span> <span class="nx">minifyCSS</span> <span class="nx">filename</span><span class="p">,</span> <span class="nx">css</span><span class="p">,</span> <span class="nx">structureOff</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="requiring">Requiring</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Remember require references</p></div></div><div class="code"><div class="wrapper"><span class="nv">_rememberModule = </span><span class="nf">(modules, filename, code, module) -&gt;</span>
  <span class="nx">verbose</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;found </span><span class="si">#{</span><span class="nx">filename</span><span class="si">}</span><span class="s">&quot;</span> <span class="k">if</span> <span class="nx">code</span>
  <span class="nx">modules</span><span class="p">[</span><span class="nx">filename</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">defaults</span> <span class="p">{</span><span class="nv">code: </span><span class="nx">code</span><span class="p">,</span> <span class="nv">module: </span><span class="nx">module</span><span class="p">},</span> <span class="p">(</span><span class="nx">modules</span><span class="p">[</span><span class="nx">filename</span><span class="p">]</span> <span class="o">or</span> <span class="p">{})</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Hooking into require inspired by http://github.com/fgnass/node-dev</p></div></div><div class="code"><div class="wrapper"><span class="nv">_cacheHooks = </span><span class="p">{}</span>
<span class="nv">_cacheOrigs = </span><span class="p">{}</span>
<span class="nv">_hookRequire = </span><span class="nf">(modules) -&gt;</span>
  <span class="nv">handlers = </span><span class="nx">require</span><span class="p">.</span><span class="nx">extensions</span>
  <span class="k">for</span> <span class="nx">ext</span> <span class="k">of</span> <span class="nx">handlers</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get or create the hook for the extension</p></div></div><div class="code"><div class="wrapper">    <span class="nv">hook = </span><span class="nx">_cacheHooks</span><span class="p">[</span><span class="nx">ext</span><span class="p">]</span> <span class="o">or</span> <span class="p">(</span><span class="nx">_cacheHooks</span><span class="p">[</span><span class="nx">ext</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_createHook</span><span class="p">(</span><span class="nx">ext</span><span class="p">,</span> <span class="nx">modules</span><span class="p">))</span>
    <span class="k">if</span> <span class="nx">handlers</span><span class="p">[</span><span class="nx">ext</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">hook</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Save a reference to the original handler</p></div></div><div class="code"><div class="wrapper">      <span class="nx">_cacheOrigs</span><span class="p">[</span><span class="nx">ext</span><span class="p">]</span> <span class="o">=</span> <span class="nx">handlers</span><span class="p">[</span><span class="nx">ext</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>and replace the handler by our hook</p></div></div><div class="code"><div class="wrapper">      <span class="nx">handlers</span><span class="p">[</span><span class="nx">ext</span><span class="p">]</span> <span class="o">=</span> <span class="nx">hook</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Hook into one extension</p></div></div><div class="code"><div class="wrapper"><span class="nv">_createHook = </span><span class="nf">(ext, modules) -&gt;</span>
  <span class="k">return</span> <span class="nf">(module, filename) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Override compile to intercept file</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="o">!</span><span class="nx">module</span><span class="p">.</span><span class="nx">loaded</span>
      <span class="nx">_rememberModule</span> <span class="nx">modules</span><span class="p">,</span> <span class="nx">filename</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">module</span><span class="p">.</span><span class="nx">paths</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if path.extension filename _.indexOf ['.coffee']</p></div></div><div class="code"><div class="wrapper">      <span class="nv">moduleCompile = </span><span class="nx">module</span><span class="p">.</span><span class="nx">_compile</span>
      <span class="nv">module._compile = </span><span class="nf">(code) -&gt;</span>
        <span class="nx">_rememberModule</span> <span class="nx">modules</span><span class="p">,</span> <span class="nx">filename</span><span class="p">,</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">module</span><span class="p">.</span><span class="nx">paths</span>
        <span class="k">return</span> <span class="nx">moduleCompile</span><span class="p">.</span><span class="nx">apply</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Invoke the original handler</p></div></div><div class="code"><div class="wrapper">    <span class="nx">_cacheOrigs</span><span class="p">[</span><span class="nx">ext</span><span class="p">](</span><span class="nx">module</span><span class="p">,</span> <span class="nx">filename</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Make sure the module did not hijack the handler</p></div></div><div class="code"><div class="wrapper">    <span class="nx">_hookRequire</span> <span class="nx">modules</span>

<span class="nv">_nodeModulesSupported = </span><span class="nx">oj</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">assert</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">console</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">crypto</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">events</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">freelist</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">path</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">punycode</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">querystring</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">string_decoder</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">tty</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">url</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">util</span><span class="o">:</span><span class="mi">1</span>
<span class="nv">_nodeModuleUnsupported = </span><span class="nx">child_process</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">domain</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">fs</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">net</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">os</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">vm</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">buffer</span><span class="o">:</span><span class="mi">1</span>
<span class="nv">isNodeModule = </span><span class="nf">(module) -&gt;</span> <span class="o">!!</span><span class="nx">_nodeModulesSupported</span><span class="p">[</span><span class="nx">module</span><span class="p">]</span>
<span class="nv">isUnsupportedNodeModule = </span><span class="nf">(module) -&gt;</span> <span class="o">!!</span><span class="nx">_nodeModuleUnsupported</span><span class="p">[</span><span class="nx">module</span><span class="p">]</span>
<span class="nv">isAppModule = </span><span class="nf">(module) -&gt;</span> <span class="p">(</span><span class="nx">module</span><span class="p">.</span><span class="nx">indexOf</span> <span class="s">&#39;/&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
<span class="nv">isRelativeModule = </span><span class="nf">(module) -&gt;</span> <span class="p">(</span><span class="nx">module</span><span class="p">.</span><span class="nx">indexOf</span> <span class="s">&#39;/&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>

<span class="nv">_requireCache = </span><span class="kc">null</span>
<span class="nv">_saveRequireCache = </span><span class="o">-&gt;</span>
  <span class="nv">_requireCache = </span><span class="nx">_</span><span class="p">.</span><span class="nx">clone</span> <span class="nx">require</span><span class="p">.</span><span class="nx">cache</span>

<span class="nv">_restoreRequireCache = </span><span class="o">-&gt;</span>
  <span class="nv">require.cache = </span><span class="nx">_requireCache</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Clear one record. This does not work in general because
it doesn't recurse. It does work on stand alone modules
like 'path' and 'underscore'</p></div></div><div class="code"><div class="wrapper"><span class="nv">_clearRequireCacheRecord = </span><span class="nf">(record) -&gt;</span>
  <span class="k">delete</span> <span class="nx">require</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">require</span><span class="p">.</span><span class="nx">resolve</span> <span class="nx">record</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Parse code with</p></div></div><div class="code"><div class="wrapper"><span class="nv">_getRequiresInSource = </span><span class="nf">(code) -&gt;</span>
  <span class="nv">r = </span><span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s">&quot;require\\s*\\(?\\s*[\&quot;&#39;]([^\&quot;&#39;]+)&quot;</span><span class="p">,</span> <span class="s">&#39;g&#39;</span><span class="p">);</span>
  <span class="nv">out = </span><span class="p">[]</span>
  <span class="k">while</span> <span class="nv">match = </span><span class="nx">r</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">code</span>
    <span class="nx">out</span><span class="p">.</span><span class="nx">push</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  <span class="nx">out</span>

<span class="nv">_first = </span><span class="nf">(array, fn) -&gt;</span>
  <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">array</span>
    <span class="nv">y = </span><span class="nx">fn</span> <span class="nx">x</span>
    <span class="k">return</span> <span class="nx">y</span> <span class="k">if</span> <span class="nx">y</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Load all modules by reading them if they are missing</p></div></div><div class="code"><div class="wrapper"><span class="nv">_buildRequireCache = </span><span class="nf">(modules, cache) -&gt;</span>
  <span class="k">for</span> <span class="nx">filename</span><span class="p">,</span> <span class="nx">data</span> <span class="k">of</span> <span class="nx">modules</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Read code if it is missing</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="o">not</span> <span class="nx">data</span><span class="p">.</span><span class="nx">code</span><span class="o">?</span>
      <span class="nv">data.code = </span><span class="nx">stripBOM</span> <span class="nx">readFileSync</span> <span class="nx">filename</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Save code to _fileCache</p></div></div><div class="code"><div class="wrapper">    <span class="nx">_buildFileCache</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">files</span><span class="p">,</span> <span class="nx">filename</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">code</span><span class="p">,</span> <span class="nx">commander</span><span class="p">.</span><span class="nx">debug</span>

    <span class="nv">pathComponents = </span><span class="nx">_first</span> <span class="nx">module</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">paths</span><span class="p">,</span> <span class="nf">(prefix) -&gt;</span>
      <span class="k">if</span> <span class="nx">_startsWith</span> <span class="nx">filename</span><span class="p">,</span> <span class="nx">prefix</span> <span class="o">+</span> <span class="nx">path</span><span class="p">.</span><span class="nx">sep</span>
        <span class="nv">modulePath = </span><span class="p">(</span><span class="nx">filename</span><span class="p">.</span><span class="nx">slice</span> <span class="p">(</span><span class="nx">prefix</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)).</span><span class="nx">split</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">sep</span><span class="p">)</span>
        <span class="nv">moduleName = </span><span class="nx">modulePath</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nv">moduleMain = </span><span class="nx">modulePath</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">sep</span><span class="p">)</span>
        <span class="nv">modulesDir: </span><span class="nx">prefix</span><span class="p">,</span> <span class="nv">moduleName: </span> <span class="nx">moduleName</span><span class="p">,</span> <span class="nv">moduleMain: </span><span class="nx">moduleMain</span><span class="p">,</span> <span class="nv">moduleParentPath: </span><span class="nx">module</span><span class="p">.</span><span class="nx">id</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Save to cache.native</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">pathComponents</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">pathComponents</span><span class="p">.</span><span class="nx">modulesDir</span><span class="p">]</span>
        <span class="nx">cache</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">pathComponents</span><span class="p">.</span><span class="nx">modulesDir</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Example: /Users/evan/oj/node_modules: {underscore: 'underscore.js'}</p></div></div><div class="code"><div class="wrapper">      <span class="nx">cache</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">pathComponents</span><span class="p">.</span><span class="nx">modulesDir</span><span class="p">][</span><span class="nx">pathComponents</span><span class="p">.</span><span class="nx">moduleName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">pathComponents</span><span class="p">.</span><span class="nx">moduleMain</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Build cache.native given source code in _fileCache</p></div></div><div class="code"><div class="wrapper">    <span class="nx">_buildNativeCache</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">native</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">code</span><span class="p">,</span> <span class="nx">commander</span><span class="p">.</span><span class="nx">debug</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Store complete</p></div></div><div class="code"><div class="wrapper">    <span class="nx">verbose</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;stored </span><span class="si">#{</span><span class="nx">filename</span><span class="si">}</span><span class="s">&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Remove local oj if it exists.
This is a special case of the way stuff is included.
To ourselves oj is local so that is what is auto
detected, but to them oj is native. Removing this
cache record ensures only the native copy persists.</p></div></div><div class="code"><div class="wrapper">  <span class="k">delete</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">files</span><span class="p">[</span><span class="nx">require</span><span class="p">.</span><span class="nx">resolve</span> <span class="s">&#39;oj&#39;</span><span class="p">]</span>

  <span class="k">return</span> <span class="nx">cache</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="-buildfilecache-build-file-cache">_buildFileCache: build file cache</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="nv">_buildFileCache = </span><span class="nf">(_filesCache, filename, code, isDebug) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Minify code if necessary and cache it</p></div></div><div class="code"><div class="wrapper">  <span class="nx">_filesCache</span><span class="p">[</span><span class="nx">filename</span><span class="p">]</span> <span class="o">=</span> <span class="nx">minifyJSUnless</span> <span class="nx">isDebug</span><span class="p">,</span> <span class="nx">filename</span><span class="p">,</span> <span class="nx">code</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>build native module cache given moduleNameList</p></div></div><div class="code"><div class="wrapper"><span class="nv">pass = </span><span class="mi">1</span>

<span class="nv">_buildNativeCache = </span><span class="nf">(nativeCache, code, isDebug) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get moduleName references from code</p></div></div><div class="code"><div class="wrapper">  <span class="nv">moduleNameList = </span><span class="nx">_getRequiresInSource</span> <span class="nx">code</span>
  <span class="nx">_buildNativeCacheFromModuleList</span> <span class="nx">nativeCache</span><span class="p">,</span> <span class="nx">moduleNameList</span><span class="p">,</span> <span class="nx">isDebug</span>

<span class="nv">_buildNativeCacheFromModuleList = </span><span class="nf">(nativeCache, moduleNameList, isDebug) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Loop over modules and add them to native cache</p></div></div><div class="code"><div class="wrapper">  <span class="k">while</span> <span class="nv">moduleName = </span><span class="nx">moduleNameList</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Continue on already loaded native modules</p></div></div><div class="code"><div class="wrapper">    <span class="k">continue</span> <span class="k">if</span> <span class="nx">nativeCache</span><span class="p">[</span><span class="nx">moduleName</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>OJ is built in</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">moduleName</span> <span class="o">==</span> <span class="s">&#39;oj&#39;</span>
      <span class="nv">nativeCache.oj = </span><span class="nx">_ojModuleCode</span> <span class="nx">isDebug</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Do nothing if unsupported
Error checking happens earlier and missing modules at this stage are intentional</p></div></div><div class="code"><div class="wrapper">    <span class="k">else</span> <span class="k">if</span> <span class="nx">isUnsupportedNodeModule</span> <span class="nx">moduleName</span>
      <span class="nx">pass</span>

    <span class="k">else</span> <span class="k">if</span> <span class="nx">isNodeModule</span> <span class="nx">moduleName</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get code</p></div></div><div class="code"><div class="wrapper">      <span class="nv">codeModule = </span><span class="nx">_nativeModuleCode</span> <span class="nx">moduleName</span><span class="p">,</span> <span class="nx">isDebug</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Cache it</p></div></div><div class="code"><div class="wrapper">      <span class="nx">nativeCache</span><span class="p">[</span><span class="nx">moduleName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">codeModule</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Concat all dependencies and continue on</p></div></div><div class="code"><div class="wrapper">      <span class="nv">moduleNameList = </span><span class="nx">moduleNameList</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">_getRequiresInSource</span> <span class="nx">codeModule</span>

    <span class="k">else</span>
      <span class="nx">pass</span>
  <span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>ojModuleCode: Get code for oj</p></div></div><div class="code"><div class="wrapper"><span class="nv">_ojModuleCode = </span><span class="nf">(isDebug) -&gt;</span>
  <span class="nv">code = </span><span class="nx">readFileSync</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span> <span class="nx">__dirname</span><span class="p">,</span> <span class="s">&quot;../lib/oj.js&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Minify code if not debugging</p></div></div><div class="code"><div class="wrapper">  <span class="nx">minifyJSUnless</span> <span class="nx">isDebug</span><span class="p">,</span> <span class="s">&#39;oj&#39;</span><span class="p">,</span> <span class="nx">code</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>nativeModuleCode: Get code for native module</p></div></div><div class="code"><div class="wrapper"><span class="nv">_nativeModuleCode = </span><span class="nf">(moduleName, isDebug) -&gt;</span>
  <span class="nx">verbose</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;found </span><span class="si">#{</span><span class="nx">moduleName</span><span class="si">}</span><span class="s">&quot;</span> <span class="k">if</span> <span class="nx">isDebug</span>
  <span class="nv">code = </span><span class="nx">readFileSync</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span> <span class="nx">__dirname</span><span class="p">,</span> <span class="s">&quot;../modules/</span><span class="si">#{</span><span class="nx">moduleName</span><span class="si">}</span><span class="s">.js&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Minify code if not debugging</p></div></div><div class="code"><div class="wrapper">  <span class="nx">minifyJSUnless</span> <span class="nx">isDebug</span><span class="p">,</span> <span class="nx">moduleName</span><span class="p">,</span> <span class="nx">code</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="templating">Templating</h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="code-generation">Code generation</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="-requirecachetostring">_requireCacheToString</h3>

<p>Output html from cache and file</p></div></div><div class="code"><div class="wrapper"><span class="nv">_requireCacheToString = </span><span class="nf">(cache, isDebug) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Maps from moduleDir -> moduleName -> moduleMain such that
the file path is: moduleDir/moduleName/moduleMain</p></div></div><div class="code"><div class="wrapper">  <span class="nv">_modulesToString = </span><span class="nf">(moduleDir, nameToMain) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Use relative path to hide server directory info</p></div></div><div class="code"><div class="wrapper">    <span class="nv">moduleDir = </span><span class="nx">relativePathWithEscaping</span> <span class="nx">moduleDir</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">()</span>
    <span class="s">&quot;M[&#39;</span><span class="si">#{</span><span class="nx">moduleDir</span><span class="si">}</span><span class="s">&#39;] = </span><span class="si">#{</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span> <span class="nx">nameToMain</span><span class="si">}</span><span class="s">;\n&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Maps moduleName -> code for built in "native" modules</p></div></div><div class="code"><div class="wrapper">  <span class="nv">_nativeModuleToString = </span><span class="nf">(moduleName, code) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Use relative path to hide server directory info</p></div></div><div class="code"><div class="wrapper">    <span class="nv">moduleName = </span><span class="nx">_escapeSingleQuotes</span> <span class="nx">moduleName</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;moduleName is undefined: &quot;</span><span class="p">,</span> <span class="nx">moduleName</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">code</span>
    <span class="s">&quot;F[&#39;</span><span class="si">#{</span><span class="nx">moduleName</span><span class="si">}</span><span class="s">&#39;] = (function(module,exports){(function(require,process,global,__dirname,__filename){</span><span class="si">#{</span><span class="nx">code</span><span class="si">}</span><span class="s">})(RR(&#39;/&#39;),P,G,&#39;/&#39;,&#39;</span><span class="si">#{</span><span class="nx">moduleName</span><span class="si">}</span><span class="s">&#39;);});\n&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Maps filePath -> code</p></div></div><div class="code"><div class="wrapper">  <span class="nv">_fileToString = </span><span class="nf">(filePath, code) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Use relative and escaped path</p></div></div><div class="code"><div class="wrapper">    <span class="nv">filePath = </span><span class="nx">relativePathWithEscaping</span> <span class="nx">filePath</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">()</span>
    <span class="nv">fileDir = </span><span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span> <span class="nx">filePath</span>
    <span class="nv">fileName = </span><span class="nx">path</span><span class="p">.</span><span class="nx">basename</span> <span class="nx">filePath</span>
    <span class="s">&quot;F[&#39;</span><span class="si">#{</span><span class="nx">filePath</span><span class="si">}</span><span class="s">&#39;] = (function(module,exports){(function(require,process,global,__dirname,__filename){</span><span class="si">#{</span><span class="nx">code</span><span class="si">}</span><span class="s">})(RR(&#39;</span><span class="si">#{</span><span class="nx">filePath</span><span class="si">}</span><span class="s">&#39;),P,G,&#39;</span><span class="si">#{</span><span class="nx">fileDir</span><span class="si">}</span><span class="s">&#39;,&#39;</span><span class="si">#{</span><span class="nx">fileName</span><span class="si">}</span><span class="s">&#39;);});\n&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Client side code to include modules</p></div></div><div class="code"><div class="wrapper">  <span class="nv">_modules = </span><span class="s">&quot;&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>{ '/Users/evan/oj/node_modules': { underscore: 'underscore.js' } }</p></div></div><div class="code"><div class="wrapper">  <span class="k">for</span> <span class="nx">moduleDir</span><span class="p">,</span> <span class="nx">nameToMain</span> <span class="k">of</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">modules</span>
    <span class="nx">_modules</span> <span class="o">+=</span> <span class="nx">_modulesToString</span> <span class="nx">moduleDir</span><span class="p">,</span> <span class="nx">nameToMain</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Client side code to include files</p></div></div><div class="code"><div class="wrapper">  <span class="nv">_files = </span><span class="s">&quot;&quot;</span>
  <span class="k">for</span> <span class="nx">filePath</span><span class="p">,</span> <span class="nx">code</span> <span class="k">of</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">files</span>
    <span class="nx">_files</span> <span class="o">+=</span> <span class="nx">_fileToString</span> <span class="nx">filePath</span><span class="p">,</span> <span class="nx">code</span>
    <span class="nx">verbose</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;serialized `</span><span class="si">#{</span><span class="nx">filePath</span><span class="si">}</span><span class="s">`&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Client side code to include native modules</p></div></div><div class="code"><div class="wrapper">  <span class="nv">_native = </span><span class="s">&quot;&quot;</span>
  <span class="k">for</span> <span class="nx">moduleName</span><span class="p">,</span> <span class="nx">code</span> <span class="k">of</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">native</span>
    <span class="nx">_native</span> <span class="o">+=</span> <span class="nx">_nativeModuleToString</span> <span class="nx">moduleName</span><span class="p">,</span> <span class="nx">code</span>
    <span class="nx">verbose</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;serialized &#39;</span><span class="si">#{</span><span class="nx">moduleName</span><span class="si">}</span><span class="s">&#39;&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Client side function to run module and cache result</p></div></div><div class="code"><div class="wrapper">  <span class="nv">_run = </span><span class="nx">minifySimpleJSUnless</span> <span class="nx">isDebug</span><span class="p">,</span> <span class="s">&quot;&quot;&quot;function run(f) {</span>
<span class="s">    if(R[f] != null)</span>
<span class="s">      return R[f];</span>
<span class="s">    var eo = {},</span>
<span class="s">      mo = {exports: eo};</span>
<span class="s">    if(typeof F[f] != &#39;function&#39;)</span>
<span class="s">      throw new Error(&quot;file not found (&quot; + f + &quot;)&quot;);</span>
<span class="s">    F[f](mo,eo);</span>
<span class="s">    return R[f] = mo.exports;</span>
<span class="s">  }</span>
<span class="s">  &quot;&quot;&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Client side function to find module</p></div></div><div class="code"><div class="wrapper">  <span class="nv">_find = </span><span class="nx">minifySimpleJSUnless</span> <span class="nx">isDebug</span><span class="p">,</span> <span class="s">&quot;&quot;&quot;function find(m,f){</span>
<span class="s">    var r, p, dir, dm, ext, ex, i;</span>

<span class="s">    if (F[m] &amp;&amp; F[m][0] !== &#39;/&#39;) return m;</span>

<span class="s">    p = require(&#39;path&#39;);</span>

<span class="s">    if (!!m.match(/\\//)) {</span>
<span class="s">      r = p.resolve(f, p.join(p.dirname(f), m));</span>
<span class="s">      ext = [&#39;.oj&#39;,&#39;.coffee&#39;,&#39;.js&#39;,&#39;.json&#39;];</span>
<span class="s">      for(i = 0; i &lt; ext.length; i++) {</span>
<span class="s">        ex = ext[i];</span>
<span class="s">        if(F[r+ex])</span>
<span class="s">          return r+ex;</span>
<span class="s">      }</span>
<span class="s">    } else {</span>
<span class="s">      dir = p.dirname(f);</span>
<span class="s">      while(true) {</span>
<span class="s">        dm = p.join(dir, &#39;node_modules&#39;);</span>
<span class="s">        if(M[dm] &amp;&amp; M[dm][m])</span>
<span class="s">          return p.join(dm, m, M[dm][m]);</span>
<span class="s">        if(dir == &#39;/&#39;)</span>
<span class="s">          break;</span>
<span class="s">        dir = p.resolve(dir, &#39;..&#39;);</span>
<span class="s">      }</span>
<span class="s">    }</span>
<span class="s">    throw new Error(&quot;module not found (&quot; + m + &quot;)&quot;);</span>
<span class="s">  }</span>
<span class="s">  &quot;&quot;&quot;</span>

  <span class="k">return</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">&lt;script&gt;</span>
<span class="s">  // oj v</span><span class="si">#{</span><span class="nx">oj</span><span class="p">.</span><span class="nx">version</span><span class="si">}</span><span class="s"></span>
<span class="s">  (function(){</span>
<span class="s">    var F = {}, M = {}, R = {}, P, G, RR;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>{<em>modules}
{</em>files}
{_native}</p></div></div><div class="code"><div class="wrapper"><span class="s">    P = {cwd: function(){return &#39;/&#39;;}};</span>
<span class="s">    G = {process: P,Buffer: {}};</span>

<span class="s">    RR = function(f){</span>
<span class="s">      return function(m){return run(find(m, f));};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>{<em>run}
{</em>find}</p></div></div><div class="code"><div class="wrapper"><span class="s">    }</span>

<span class="s">    require = RR(&#39;/&#39;);</span>
<span class="s">    oj = require(&#39;oj&#39;);</span>

<span class="s">  }).call(this);</span>
<span class="s">&lt;/script&gt;</span>
<span class="s">&quot;&quot;&quot;</span></div></div></div></div></body></html>